# Story 3.2: Implement File System Data Layer

## Status

Done

## Story

**As a** developer,
**I want** the dashboard to read data directly from `.harshJudge/` files,
**so that** no backend API is required for data access.

## Acceptance Criteria

1. Data layer module reads `.harshJudge/` directory structure
2. `useProjects()` hook returns list of discovered projects
3. `useScenarios(projectPath)` hook returns scenarios for given project
4. `useScenarioDetail(scenarioSlug)` hook returns full scenario with runs
5. `useRunDetail(scenarioSlug, runId)` hook returns run results and evidence paths
6. Data layer handles missing files gracefully (empty state, not errors)
7. TypeScript types imported from `@harshjudge/shared`
8. Unit tests mock file system reads and verify data transformation

## Tasks / Subtasks

- [ ] Task 1: Create DataService class (AC: 1, 6, 7)
  - [ ] Create `src/services/DataService.ts`
  - [ ] Implement `getProjects()` method to scan for `.harshJudge/` directories
  - [ ] Implement `getScenarios(projectPath)` to read scenario directories
  - [ ] Implement `getScenarioDetail(projectPath, slug)` to read scenario + runs
  - [ ] Implement `getRunDetail(projectPath, slug, runId)` to read run result + evidence
  - [ ] Handle missing files gracefully returning empty/null states
  - [ ] Import types from `@harshjudge/shared`

- [ ] Task 2: Create useProjects hook (AC: 2)
  - [ ] Create `src/hooks/useProjects.ts`
  - [ ] Hook calls DataService.getProjects()
  - [ ] Return loading, error, and data states
  - [ ] Return `ProjectSummary[]` type

- [ ] Task 3: Create useScenarios hook (AC: 3)
  - [ ] Create `src/hooks/useScenarios.ts`
  - [ ] Accept `projectPath` parameter
  - [ ] Hook calls DataService.getScenarios(projectPath)
  - [ ] Return loading, error, and data states
  - [ ] Return `ScenarioSummary[]` type

- [ ] Task 4: Create useScenarioDetail hook (AC: 4)
  - [ ] Create `src/hooks/useScenarioDetail.ts`
  - [ ] Accept `projectPath` and `scenarioSlug` parameters
  - [ ] Hook calls DataService.getScenarioDetail()
  - [ ] Return `ScenarioDetail` with runs
  - [ ] Return loading, error, and data states

- [ ] Task 5: Create useRunDetail hook (AC: 5)
  - [ ] Create `src/hooks/useRunDetail.ts`
  - [ ] Accept `projectPath`, `scenarioSlug`, and `runId` parameters
  - [ ] Hook calls DataService.getRunDetail()
  - [ ] Return `RunDetail` with evidence paths
  - [ ] Return loading, error, and data states

- [ ] Task 6: Create helper parsers (AC: 1)
  - [ ] Create `src/lib/parsers.ts`
  - [ ] Implement YAML parsing (js-yaml)
  - [ ] Implement Markdown frontmatter parsing
  - [ ] Implement JSON parsing for result.json

- [ ] Task 7: Write unit tests with mocked filesystem (AC: 8)
  - [ ] Create `tests/services/DataService.test.ts`
  - [ ] Mock fs/promises using memfs or vi.mock
  - [ ] Test getProjects returns correct structure
  - [ ] Test getScenarios transforms meta.yaml correctly
  - [ ] Test getScenarioDetail includes runs
  - [ ] Test getRunDetail includes evidence paths
  - [ ] Test graceful handling of missing files

## Dev Notes

### Previous Story Insights
- Story 3.1 established Vite + React + TailwindCSS foundation
- Path aliases working: `@/services`, `@/hooks`, `@/lib`
- Types available from `@harshjudge/shared` workspace package

### File System Directory Structure
[Source: architecture/8-database-schema.md#81-directory-structure-schema]

```
.harshJudge/
├── config.yaml                           # Project configuration
├── .gitignore                            # Git ignore patterns
└── scenarios/
    └── {scenario-slug}/                  # One directory per scenario
        ├── scenario.md                   # Scenario definition (YAML frontmatter + MD)
        ├── meta.yaml                     # Statistics (machine-updated)
        └── runs/
            └── {run-id}/                 # One directory per run
                ├── result.json           # Run outcome
                ├── skill-state.yaml      # Skill execution state
                └── evidence/
                    ├── step-01-{name}.png
                    ├── step-01-{name}.meta.json
```

### Data Models (Types from @harshjudge/shared)
[Source: architecture/4-data-models.md]

**HarshJudgeConfig:**
```typescript
interface HarshJudgeConfig {
  projectName: string;
  baseUrl: string;
  version: string;
  createdAt: string;
}
```

**ScenarioMeta:**
```typescript
interface ScenarioMeta {
  totalRuns: number;
  passCount: number;
  failCount: number;
  lastRun: string | null;
  lastResult: 'pass' | 'fail' | null;
  avgDuration: number;
}
```

**RunResult:**
```typescript
interface RunResult {
  runId: string;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  failedStep: number | null;
  errorMessage: string | null;
  stepCount: number;
  evidenceCount: number;
}
```

**ScenarioSummary (for hooks):**
```typescript
interface ScenarioSummary {
  slug: string;
  title: string;
  tags: string[];
  lastResult: 'pass' | 'fail' | null;
  lastRun: string | null;
  totalRuns: number;
  passRate: number;
}
```

**ScenarioDetail:**
```typescript
interface ScenarioDetail {
  slug: string;
  title: string;
  tags: string[];
  content: string;
  meta: ScenarioMeta;
  recentRuns: RunSummary[];
}
```

### Frontend Services Architecture
[Source: architecture/9-frontend-architecture.md#94-frontend-services-layer]

**DataService Pattern:**
```typescript
// packages/ux/src/services/DataService.ts
import { readFile, readdir } from 'fs/promises';
import { join } from 'path';
import yaml from 'js-yaml';

export class DataService {
  constructor(private basePath: string) {}

  async getProjects(): Promise<ProjectSummary[]> {
    // Find all .harshJudge directories
    // Parse config.yaml from each
    // Calculate aggregate status
  }

  async getScenarios(projectPath: string): Promise<ScenarioSummary[]> {
    const scenariosPath = join(projectPath, 'scenarios');
    const dirs = await readdir(scenariosPath, { withFileTypes: true });
    // ... parse meta.yaml for each
  }
}
```

### Required Dependencies
[Source: architecture/3-tech-stack.md]

| Dependency | Purpose |
|------------|---------|
| `js-yaml` | YAML parsing for config.yaml, meta.yaml |
| `marked` | Markdown parsing (for future content rendering) |
| `@harshjudge/shared` | Type definitions |

**Note:** Need to add `js-yaml` to packages/ux/package.json dependencies

### Indexing Strategy
[Source: architecture/8-database-schema.md#83-indexing-strategy]

Since file-system-as-database doesn't support queries:
1. On Load: Read all `meta.yaml` files into memory
2. On Change: File watcher triggers selective re-read (Story 3.3)
3. Performance: For 100+ scenarios, < 1s load time

### Graceful Error Handling
[Source: AC 6]

Handle missing files gracefully:
- Missing `.harshJudge/` → empty projects array
- Missing `scenarios/` → empty scenarios array
- Missing `meta.yaml` → default meta values (totalRuns: 0, etc.)
- Missing `result.json` → null run result

### Testing

**Test Location:** `packages/ux/tests/services/`
[Source: architecture/15-testing-strategy.md]

**Mocking Strategy:**
```typescript
import { vol } from 'memfs';

vi.mock('fs/promises', async () => {
  const memfs = await import('memfs');
  return memfs.fs.promises;
});

beforeEach(() => {
  vol.reset();
  // Set up virtual file system
  vol.fromJSON({
    '.harshJudge/config.yaml': 'projectName: Test\nbaseUrl: http://localhost',
    '.harshJudge/scenarios/login/meta.yaml': 'totalRuns: 5\nlastResult: pass',
  });
});
```

## Dev Agent Record

### Implementation Summary
Implemented complete file system data layer for reading `.harshJudge/` directory structure:

**Files Created:**
- `src/services/DataService.ts` - Core data layer class (364 lines)
- `src/hooks/useProjects.ts` - Hook for project discovery
- `src/hooks/useScenarios.ts` - Hook for scenario listing
- `src/hooks/useScenarioDetail.ts` - Hook for scenario + runs detail
- `src/hooks/useRunDetail.ts` - Hook for run results + evidence
- `src/lib/parsers.ts` - YAML/JSON parsing utilities
- `tests/services/DataService.test.ts` - 10 unit tests

**Files Modified:**
- `package.json` - Added `js-yaml`, `@types/js-yaml`, `memfs` dependencies
- `src/services/index.ts` - Export DataService and types
- `src/hooks/index.ts` - Export all hooks
- `src/lib/index.ts` - Export parser utilities

**Key Implementation Details:**
- DataService reads `.harshJudge/config.yaml`, `scenarios/*/meta.yaml`, `scenario.md`, `runs/*/result.json`
- All methods handle missing files gracefully (return `[]` or `null`)
- Types imported from `@harshjudge/shared` package
- Hooks follow standard React pattern with loading/error/data/refetch
- Tests use `vi.mock('fs/promises')` with manual mock functions

### Verification
- Unit Tests: 12 passed (10 DataService + 2 App)
- Build: ✅ Successful (143KB bundle)
- TypeScript: ✅ No errors

---

## QA Results

### Test Execution
- **Date:** 2025-12-05
- **Test Files:** 2 passed
- **Tests:** 12 passed
- **Build:** ✅ Successful

### Acceptance Criteria Verification

| AC# | Criterion | Status | Evidence |
|-----|-----------|--------|----------|
| 1 | Data layer module reads `.harshJudge/` directory structure | ✅ PASS | `DataService.ts:33-59` |
| 2 | `useProjects()` hook returns list of discovered projects | ✅ PASS | `useProjects.ts:11-43` |
| 3 | `useScenarios(projectPath)` hook returns scenarios for given project | ✅ PASS | `useScenarios.ts:12-49` |
| 4 | `useScenarioDetail(scenarioSlug)` hook returns full scenario with runs | ✅ PASS | `useScenarioDetail.ts:12-52` |
| 5 | `useRunDetail(scenarioSlug, runId)` hook returns run results and evidence paths | ✅ PASS | `useRunDetail.ts:11-52` |
| 6 | Data layer handles missing files gracefully (empty state, not errors) | ✅ PASS | Tests verify graceful handling |
| 7 | TypeScript types imported from `@harshjudge/shared` | ✅ PASS | `DataService.ts:4-11` |
| 8 | Unit tests mock file system reads and verify data transformation | ✅ PASS | 10 tests with mocked fs |

### QA Notes
- Minor TypeScript type narrowing fix applied during QA for regex match array indexing
- All graceful error handling paths covered by unit tests
- Code follows DRY principle with shared helper methods

**QA Result:** ✅ APPROVED

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story draft | SM Agent |
| 2025-12-05 | 1.1 | Implementation complete | Dev Agent |
| 2025-12-05 | 1.2 | QA approved, status → Done | QA Agent |
