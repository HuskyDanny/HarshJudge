# Story 1.3: Implement Shared Types Package

## Status

Done

## Story

**As a** developer,
**I want** a shared types package with core TypeScript interfaces,
**so that** all packages use consistent type definitions.

## Acceptance Criteria

1. `packages/shared/src/types/` directory structure created
2. `HarshJudgeConfig` interface for `config.yaml` structure
3. `Scenario` and `ScenarioMeta` interfaces for scenario files
4. `Run`, `RunResult`, and `Evidence` interfaces for run data
5. `ProjectStatus` and `ScenarioStatus` interfaces for status queries
6. MCP tool parameter and response interfaces for all 6 tools
7. `Result<T, E>` type for explicit error handling
8. Package exports all types via barrel file (`index.ts`)
9. Types are importable from other packages via `@harshjudge/shared`

## Tasks / Subtasks

- [x] **Task 1: Create types directory structure** (AC: 1)
  - [x] Create `packages/shared/src/types/` directory
  - [x] Create empty type files: `config.ts`, `scenario.ts`, `run.ts`, `evidence.ts`, `status.ts`, `mcp-tools.ts`
  - [x] Create `packages/shared/src/utils/` directory
  - [x] Create `result.ts` utility file

- [x] **Task 2: Implement config types** (AC: 2)
  - [x] Create `HarshJudgeConfig` interface in `types/config.ts`
  - [x] Export interface via barrel file

- [x] **Task 3: Implement scenario types** (AC: 3)
  - [x] Create `Scenario` interface in `types/scenario.ts`
  - [x] Create `ScenarioFrontmatter` interface in `types/scenario.ts`
  - [x] Create `ScenarioMeta` interface in `types/scenario.ts`
  - [x] Export all interfaces via barrel file

- [x] **Task 4: Implement run types** (AC: 4)
  - [x] Create `Run` interface in `types/run.ts`
  - [x] Create `RunResult` interface in `types/run.ts`
  - [x] Export all interfaces via barrel file

- [x] **Task 5: Implement evidence types** (AC: 4)
  - [x] Create `EvidenceType` union type in `types/evidence.ts`
  - [x] Create `Evidence` interface in `types/evidence.ts`
  - [x] Create `EvidenceMeta` interface in `types/evidence.ts`
  - [x] Export all types/interfaces via barrel file

- [x] **Task 6: Implement status types** (AC: 5)
  - [x] Create `ScenarioSummary` interface in `types/status.ts`
  - [x] Create `ProjectStatus` interface in `types/status.ts`
  - [x] Create `ScenarioDetail` interface in `types/status.ts`
  - [x] Create `RunSummary` interface in `types/status.ts`
  - [x] Export all interfaces via barrel file

- [x] **Task 7: Implement MCP tool types** (AC: 6)
  - [x] Add `zod` dependency to `packages/shared/package.json`
  - [x] Create Zod schemas for all 6 MCP tools in `types/mcp-tools.ts`:
    - `InitProjectParams` and `InitProjectResult`
    - `SaveScenarioParams` and `SaveScenarioResult`
    - `StartRunParams` and `StartRunResult`
    - `RecordEvidenceParams` and `RecordEvidenceResult`
    - `CompleteRunParams` and `CompleteRunResult`
    - `GetStatusParams` and `GetStatusResult`
  - [x] Export all Zod schemas and inferred types via barrel file

- [x] **Task 8: Implement Result type utility** (AC: 7)
  - [x] Create `Result<T, E>` discriminated union type in `utils/result.ts`
  - [x] Create `ok<T>()` helper function
  - [x] Create `err<E>()` helper function
  - [x] Create `isOk()` and `isErr()` type guards
  - [x] Export all utilities via barrel file

- [x] **Task 9: Update barrel file and verify exports** (AC: 8, 9)
  - [x] Update `packages/shared/src/index.ts` to re-export all types
  - [x] Run `pnpm build` to verify compilation
  - [x] Run `pnpm typecheck` to verify type correctness

- [x] **Task 10: Write unit tests for Result utility** (AC: 7)
  - [x] Create `packages/shared/tests/utils/result.test.ts`
  - [x] Test `ok()` creates success result
  - [x] Test `err()` creates failure result
  - [x] Test `isOk()` and `isErr()` type guards
  - [x] Run `pnpm test` to verify tests pass

- [x] **Task 11: Verify cross-package imports** (AC: 9)
  - [x] Temporarily import types in `packages/mcp-server/src/index.ts`
  - [x] Verify TypeScript resolves `@harshjudge/shared` correctly
  - [x] Remove temporary import after verification

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.2.story.md#Dev Agent Record]

From Story 1.2 implementation:
- Vitest workspace configured with `vitest.workspace.ts`
- Each package has `vitest.config.ts` with appropriate environments
- `packages/shared` uses `environment: 'node'` for tests
- TypeScript project references working correctly
- All validation commands (`pnpm build`, `pnpm test`, `pnpm lint`, `pnpm typecheck`) operational

### Current State of Shared Package

**Current `packages/shared/src/index.ts`:**
```typescript
// @harshjudge/shared - Shared utilities and types
export {};
```

The package is currently empty with just a placeholder export. This story will populate it with all core type definitions.

### Data Models Reference
[Source: architecture/4-data-models.md]

**4.1 HarshJudgeConfig:**
```typescript
export interface HarshJudgeConfig {
  projectName: string;
  baseUrl: string;
  version: string;
  createdAt: string;
}
```

**4.2 Scenario and 4.3 ScenarioMeta:**
```typescript
export interface Scenario {
  id: string;
  title: string;
  tags: string[];
  estimatedDuration: number;
  content: string;
}

export interface ScenarioFrontmatter {
  id: string;
  title: string;
  tags: string[];
  estimatedDuration: number;
}

export interface ScenarioMeta {
  totalRuns: number;
  passCount: number;
  failCount: number;
  lastRun: string | null;
  lastResult: 'pass' | 'fail' | null;
  avgDuration: number;
}
```

**4.4 Run and 4.5 RunResult:**
```typescript
export interface Run {
  id: string;
  scenarioSlug: string;
  runNumber: number;
  startedAt: string;
  status: 'running' | 'completed';
}

export interface RunResult {
  runId: string;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  failedStep: number | null;
  errorMessage: string | null;
  stepCount: number;
  evidenceCount: number;
}
```

**4.6 Evidence:**
```typescript
export type EvidenceType =
  | 'screenshot'
  | 'db_snapshot'
  | 'console_log'
  | 'network_log'
  | 'html_snapshot'
  | 'custom';

export interface Evidence {
  runId: string;
  step: number;
  type: EvidenceType;
  name: string;
  filePath: string;
  capturedAt: string;
  metadata?: Record<string, unknown>;
}

export interface EvidenceMeta {
  runId: string;
  step: number;
  type: EvidenceType;
  name: string;
  capturedAt: string;
  fileSize: number;
  metadata?: Record<string, unknown>;
}
```

**4.7 ProjectStatus:**
```typescript
export interface ScenarioSummary {
  slug: string;
  title: string;
  tags: string[];
  lastResult: 'pass' | 'fail' | null;
  lastRun: string | null;
  totalRuns: number;
  passRate: number;
}

export interface ProjectStatus {
  projectName: string;
  scenarioCount: number;
  passing: number;
  failing: number;
  neverRun: number;
  scenarios: ScenarioSummary[];
}

export interface ScenarioDetail {
  slug: string;
  title: string;
  tags: string[];
  content: string;
  meta: ScenarioMeta;
  recentRuns: RunSummary[];
}

export interface RunSummary {
  id: string;
  runNumber: number;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  errorMessage: string | null;
}
```

### MCP Tool Schemas Reference
[Source: architecture/5-api-specification-mcp-tools.md#51-mcp-tool-schemas]

All MCP tool parameter schemas use **Zod** for runtime validation. See Task 7 for the complete list of schemas to implement:
- `InitProjectParams` / `InitProjectResult`
- `SaveScenarioParams` / `SaveScenarioResult`
- `StartRunParams` / `StartRunResult`
- `RecordEvidenceParams` / `RecordEvidenceResult`
- `CompleteRunParams` / `CompleteRunResult`
- `GetStatusParams` / `GetStatusResult`

**Important Zod patterns:**
```typescript
import { z } from 'zod';

// Example schema definition
export const InitProjectParams = z.object({
  projectName: z.string().min(1).max(100),
  baseUrl: z.string().url().optional(),
});
export type InitProjectParams = z.infer<typeof InitProjectParams>;
```

### Result Type Pattern
[Source: Best practices for explicit error handling]

The `Result<T, E>` type provides explicit error handling without exceptions:

```typescript
// packages/shared/src/utils/result.ts
export type Result<T, E = Error> =
  | { ok: true; value: T }
  | { ok: false; error: E };

export function ok<T>(value: T): Result<T, never> {
  return { ok: true, value };
}

export function err<E>(error: E): Result<never, E> {
  return { ok: false, error };
}

export function isOk<T, E>(result: Result<T, E>): result is { ok: true; value: T } {
  return result.ok;
}

export function isErr<T, E>(result: Result<T, E>): result is { ok: false; error: E } {
  return !result.ok;
}
```

### File Locations
[Source: architecture/11-unified-project-structure.md]

**Directory structure to create:**
```
packages/shared/
├── src/
│   ├── types/
│   │   ├── config.ts         # HarshJudgeConfig
│   │   ├── scenario.ts       # Scenario, ScenarioFrontmatter, ScenarioMeta
│   │   ├── run.ts            # Run, RunResult
│   │   ├── evidence.ts       # EvidenceType, Evidence, EvidenceMeta
│   │   ├── status.ts         # ProjectStatus, ScenarioSummary, ScenarioDetail, RunSummary
│   │   └── mcp-tools.ts      # All MCP Zod schemas and types
│   ├── utils/
│   │   └── result.ts         # Result<T, E> type and helpers
│   └── index.ts              # Barrel file re-exporting all types
├── tests/
│   └── utils/
│       └── result.test.ts    # Unit tests for Result utility
└── package.json
```

### Coding Standards
[Source: architecture/16-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| TypeScript Interfaces | PascalCase | `ScenarioMeta` |
| TypeScript Types | PascalCase | `EvidenceType` |
| Functions | camelCase | `isOk`, `isErr` |
| File Names | kebab-case | `mcp-tools.ts` |

**Critical Rules:**
- Always define types in `packages/shared` and import from `@harshjudge/shared`
- All MCP tool inputs must be validated with Zod before processing

### Dependency to Add
[Source: architecture/3-tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| zod | 3+ | Runtime validation, TypeScript inference |

**Add to `packages/shared/package.json`:**
```json
{
  "dependencies": {
    "zod": "^3.0.0"
  }
}
```

### Testing
[Source: architecture/15-testing-strategy.md]

**Test Location:** `packages/shared/tests/`

**Test Framework:** Vitest 1+ (already configured in workspace)

**Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';
import { ok, err, isOk, isErr, type Result } from '../../src/utils/result';

describe('Result utilities', () => {
  it('ok() creates success result', () => {
    const result = ok(42);
    expect(result.ok).toBe(true);
    expect(result.value).toBe(42);
  });

  it('err() creates failure result', () => {
    const result = err(new Error('failed'));
    expect(result.ok).toBe(false);
    expect(result.error.message).toBe('failed');
  });

  it('isOk() returns true for success', () => {
    const result = ok('success');
    expect(isOk(result)).toBe(true);
    expect(isErr(result)).toBe(false);
  });

  it('isErr() returns true for failure', () => {
    const result = err('error');
    expect(isErr(result)).toBe(true);
    expect(isOk(result)).toBe(false);
  });
});
```

**Validation Commands:**
```bash
pnpm install          # Install zod dependency
pnpm build            # Verify types compile
pnpm test             # Verify unit tests pass
pnpm typecheck        # Verify type checking passes
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-04 | 1.1 | Implementation complete | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Created `packages/shared/src/types/` directory structure with all type files
- Created `packages/shared/src/utils/` directory with Result type utility
- Implemented all data model interfaces from architecture/4-data-models.md:
  - `HarshJudgeConfig` in config.ts
  - `Scenario`, `ScenarioFrontmatter`, `ScenarioMeta` in scenario.ts
  - `Run`, `RunResult` in run.ts
  - `EvidenceType`, `Evidence`, `EvidenceMeta` in evidence.ts
  - `ScenarioSummary`, `ProjectStatus`, `ScenarioDetail`, `RunSummary` in status.ts
- Implemented all MCP tool Zod schemas in mcp-tools.ts:
  - 6 parameter schemas with Zod validation
  - 6 result interfaces
  - Proper type inference using `z.infer<>`
- Added `zod@^3.23.0` dependency to packages/shared/package.json
- Created `Result<T, E>` discriminated union type with `ok()`, `err()`, `isOk()`, `isErr()` helpers
- Updated barrel file (index.ts) to export all types, schemas, and utilities
- Created comprehensive unit tests for Result utility (15 tests)
- All validation commands passed:
  - `pnpm build` - 3 packages built successfully
  - `pnpm test` - 18 tests passing (16 in shared + 1 in mcp-server + 1 in ux)
  - `pnpm typecheck` - No type errors
  - `pnpm lint` - No linting errors
- Verified cross-package imports work correctly from `@harshjudge/shared`

### File List

**New Files:**
- `packages/shared/src/types/config.ts` - HarshJudgeConfig interface
- `packages/shared/src/types/scenario.ts` - Scenario, ScenarioFrontmatter, ScenarioMeta interfaces
- `packages/shared/src/types/run.ts` - Run, RunResult interfaces
- `packages/shared/src/types/evidence.ts` - EvidenceType, Evidence, EvidenceMeta types/interfaces
- `packages/shared/src/types/status.ts` - ProjectStatus, ScenarioSummary, ScenarioDetail, RunSummary interfaces
- `packages/shared/src/types/mcp-tools.ts` - All 6 MCP tool Zod schemas and result types
- `packages/shared/src/utils/result.ts` - Result<T,E> type and helper functions
- `packages/shared/tests/utils/result.test.ts` - Unit tests for Result utilities

**Modified Files:**
- `packages/shared/src/index.ts` - Updated to re-export all types and utilities
- `packages/shared/package.json` - Added zod dependency
- `pnpm-lock.yaml` - Updated with zod package

---

## QA Results

### Review Date: 2025-12-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The implementation is clean, follows established patterns, and fully satisfies all acceptance criteria. Type definitions match the architecture documentation exactly, and the barrel file properly exports all types for cross-package consumption.

**Strengths:**
- All interfaces match architecture/4-data-models.md specifications exactly
- Zod schemas correctly implement validation rules from architecture/5-api-specification-mcp-tools.md
- Result<T,E> pattern is idiomatic TypeScript with proper type guards
- JSDoc comments provide clear documentation for each type
- File naming follows kebab-case convention per coding standards
- Proper use of `export type` for type-only exports (ESM best practice)
- Comprehensive unit tests for Result utility (15 tests covering all edge cases)

### Refactoring Performed

None required - implementation follows best practices.

### Compliance Check

- **Coding Standards**: ✓ PascalCase interfaces, camelCase functions, kebab-case files
- **Project Structure**: ✓ Files in correct locations per architecture/11-unified-project-structure.md
- **Type Sharing Rule**: ✓ All types in @harshjudge/shared as specified in coding standards
- **Zod Validation**: ✓ All MCP tool params use Zod schemas
- **All ACs Met**: ✓ All 9 acceptance criteria verified

### Requirements Traceability

| AC | Requirement | Validation |
|----|-------------|------------|
| 1 | types/ directory structure | ✓ `packages/shared/src/types/` created with 6 type files |
| 2 | HarshJudgeConfig interface | ✓ Implemented in `types/config.ts` with 4 properties |
| 3 | Scenario, ScenarioMeta interfaces | ✓ Implemented in `types/scenario.ts` (3 interfaces) |
| 4 | Run, RunResult, Evidence interfaces | ✓ Implemented in `types/run.ts` and `types/evidence.ts` |
| 5 | ProjectStatus interfaces | ✓ Implemented in `types/status.ts` (4 interfaces) |
| 6 | MCP tool types for all 6 tools | ✓ 6 Zod schemas + 12 types in `types/mcp-tools.ts` |
| 7 | Result<T,E> type | ✓ Implemented with ok/err/isOk/isErr helpers, 15 tests |
| 8 | Barrel file exports | ✓ `index.ts` re-exports all 25+ types/schemas |
| 9 | Cross-package imports | ✓ Verified via temporary import in mcp-server |

### Validation Results

| Command | Result |
|---------|--------|
| `pnpm build` | ✓ PASS - 3 packages built (FULL TURBO cache hit) |
| `pnpm test` | ✓ PASS - 18 tests passing (16 in shared, 1 each in mcp-server/ux) |
| `pnpm typecheck` | ✓ PASS - No type errors |
| `pnpm lint` | ✓ PASS - No linting errors |

### Security Review

**N/A** - This story contains only TypeScript type definitions and Zod validation schemas. No security-sensitive code, credentials, or runtime logic.

### Performance Considerations

**Positive findings:**
- Zod schemas are defined as constants (not recreated per validation)
- Type-only exports ensure no runtime overhead for interface imports
- Turborepo caching working correctly (FULL TURBO)

### Files Reviewed

All files verified to match architecture specifications:
- `packages/shared/src/types/config.ts` ✓
- `packages/shared/src/types/scenario.ts` ✓
- `packages/shared/src/types/run.ts` ✓
- `packages/shared/src/types/evidence.ts` ✓
- `packages/shared/src/types/status.ts` ✓
- `packages/shared/src/types/mcp-tools.ts` ✓
- `packages/shared/src/utils/result.ts` ✓
- `packages/shared/src/index.ts` ✓
- `packages/shared/tests/utils/result.test.ts` ✓

### Gate Status

Gate: **PASS**

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, all validations pass, implementation follows architecture specifications and coding standards exactly.
