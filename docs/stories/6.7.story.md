# Story 6.7: Dashboard Adaptation

## Status

Done

## Story

**As a** HarshJudge user,
**I want** the dashboard to display the new granular structure,
**so that** I can navigate steps and per-step evidence easily.

## Acceptance Criteria

1. ScenarioListPanel shows:
   - Star icon for `starred` scenarios (click to toggle)
   - Starred scenarios sorted to top (or filter option)
   - Step count badge
2. RunDetailPanel shows:
   - Per-step status timeline (pass/fail indicators)
   - Click step to expand evidence
   - Step-level timing breakdown
3. EvidencePanel updated:
   - Navigate between steps
   - Show before/after screenshots side-by-side for each step
   - Display console/network logs per step
4. `getStatus` MCP tool returns `starred` field
5. New filter option: show only starred scenarios
6. (Absorbs Story 5.2 starred scenario UI)

## Tasks / Subtasks

- [x] Task 1: Update ScenarioSummary type for dashboard (AC: 1, 4)
  - [x] Open `packages/shared/src/types/status.ts`
  - [x] Add `starred: boolean` to `ScenarioSummary` interface
  - [x] Add `stepCount: number` to `ScenarioSummary` interface
  - [x] Update `ScenarioDetail` to include `starred` field

- [x] Task 2: Update getStatus handler (AC: 4, 5)
  - [x] Open `packages/mcp-server/src/handlers/get-status.ts`
  - [x] Include `starred` field in scenario responses
  - [x] Include `stepCount` from meta.yaml steps array length
  - [x] Add `starredOnly` parameter support
  - [x] Filter scenarios when `starredOnly: true`

- [x] Task 3: Create StarButton component (AC: 1)
  - [x] Create `packages/ux/src/components/common/StarButton.tsx`
  - [x] Implement filled/outline star icon toggle
  - [x] Add onClick handler prop
  - [x] Style with TailwindCSS (yellow star when active)

- [x] Task 4: Update ScenarioListPanel (AC: 1)
  - [x] Open `packages/ux/src/components/panels/ScenarioListPanel.tsx`
  - [x] Add StarButton to each scenario item
  - [x] Sort starred scenarios to top of list
  - [x] Add step count badge (e.g., "5 steps")
  - [x] Add "Show starred only" filter toggle
  - [x] Wire up star click to toggle API call (future: MCP call)

- [x] Task 5: Create StepTimeline component (AC: 2)
  - [x] Create `packages/ux/src/components/detail/StepTimeline.tsx`
  - [x] Display horizontal timeline of step statuses
  - [x] Color code: green (pass), red (fail), gray (skipped/pending)
  - [x] Show step number and title on hover
  - [x] Highlight selected step
  - [x] onClick to select step

- [x] Task 6: Update RunDetailPanel (AC: 2)
  - [x] Open `packages/ux/src/components/panels/RunDetailPanel.tsx`
  - [x] Add StepTimeline component at top
  - [x] Show per-step timing breakdown
  - [x] Display selected step's evidence
  - [x] Show step error message if failed

- [x] Task 7: Update EvidencePanel for per-step navigation (AC: 3)
  - [x] Open `packages/ux/src/components/detail/EvidencePanel.tsx`
  - [x] Add step selector/navigation (prev/next buttons or dropdown)
  - [x] Load evidence from `step-{id}/evidence/` directory
  - [x] Show before/after screenshots side-by-side
  - [x] Add tabs for different evidence types (screenshots, console, network)

- [x] Task 8: Create useSteps hook (AC: 2, 3)
  - [x] Create `packages/ux/src/hooks/useSteps.ts`
  - [x] Fetch step list from scenario meta.yaml
  - [x] Fetch step results from run result.json
  - [x] Provide selected step state management

- [x] Task 9: Update useScenarios hook (AC: 1, 5)
  - [x] Open `packages/ux/src/hooks/useScenarios.ts`
  - [x] Add `starredOnly` filter option
  - [x] Sort scenarios with starred first
  - [x] Expose toggle function for star status

- [x] Task 10: Update DataService for new paths (AC: 3)
  - [x] Open `packages/ux/src/services/DataService.ts`
  - [x] Update `getRunDetail` to read per-step evidence paths
  - [x] Add `getStepEvidence(runPath, stepId)` method
  - [x] Handle both v1 (flat) and v2 (per-step) evidence structures

- [x] Task 11: Write component tests (AC: 1-5)
  - [x] Test StarButton toggle behavior
  - [x] Test ScenarioListPanel shows starred badge and step count
  - [x] Test StepTimeline displays correct statuses
  - [x] Test EvidencePanel navigates between steps

## Dev Notes

### Architecture References

**ScenarioSummary Type** [Source: architecture/4-data-models.md#4.10]
```typescript
export interface ScenarioSummary {
  slug: string;
  title: string;
  starred: boolean;      // NEW
  tags: string[];
  stepCount: number;     // NEW
  lastResult: 'pass' | 'fail' | null;
  lastRun: string | null;
  totalRuns: number;
  passRate: number;
}
```

**Updated GetStatusParams** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export const GetStatusParams = z.object({
  scenarioSlug: z.string().regex(/^[a-z0-9-]+$/).optional(),
  starredOnly: z.boolean().optional().default(false),  // NEW
});
```

**Frontend Component Structure** [Source: architecture/11-unified-project-structure.md]
```
packages/ux/src/components/
├── panels/
│   ├── ScenarioListPanel.tsx  # UPDATED: star icon, step count
│   ├── RunHistoryPanel.tsx
│   └── RunDetailPanel.tsx     # UPDATED: per-step view
├── detail/
│   ├── EvidencePanel.tsx      # UPDATED: step navigation
│   └── StepTimeline.tsx       # NEW: step status timeline
└── common/
    └── StarButton.tsx         # NEW: star toggle component
```

**Per-Step Evidence Path** [Source: architecture/8-database-schema.md#8.1]
```
.harshJudge/scenarios/{slug}/runs/{runId}/
├── result.json
├── step-01/
│   └── evidence/
│       ├── before.png
│       ├── after.png
│       └── console.json
├── step-02/
│   └── evidence/
└── ...
```

### File Locations

| Purpose | Path |
|---------|------|
| Status types | `packages/shared/src/types/status.ts` |
| getStatus handler | `packages/mcp-server/src/handlers/get-status.ts` |
| StarButton (NEW) | `packages/ux/src/components/common/StarButton.tsx` |
| StepTimeline (NEW) | `packages/ux/src/components/detail/StepTimeline.tsx` |
| ScenarioListPanel | `packages/ux/src/components/panels/ScenarioListPanel.tsx` |
| RunDetailPanel | `packages/ux/src/components/panels/RunDetailPanel.tsx` |
| EvidencePanel | `packages/ux/src/components/detail/EvidencePanel.tsx` |
| useSteps hook (NEW) | `packages/ux/src/hooks/useSteps.ts` |
| useScenarios hook | `packages/ux/src/hooks/useScenarios.ts` |
| DataService | `packages/ux/src/services/DataService.ts` |

### Key Implementation Notes

1. **Star Toggle**: In the dashboard, star toggle is currently display-only. Full MCP integration would require the dashboard to call `toggleStar` tool. For MVP, the star status is read from meta.yaml but toggle is manual (edit meta.yaml).

2. **Backward Compatibility**: DataService should handle both v1 (flat evidence) and v2 (per-step evidence) structures. Check for `step-01/` directory; if not present, fall back to flat structure.

3. **StepTimeline Design**:
   ```
   [01 ✓] ─ [02 ✓] ─ [03 ✗] ─ [04 ○] ─ [05 ○]
   ```
   - ✓ = pass (green)
   - ✗ = fail (red)
   - ○ = pending/skipped (gray)

4. **Evidence Side-by-Side**: For screenshot comparison, use CSS grid:
   ```tsx
   <div className="grid grid-cols-2 gap-4">
     <div>
       <h4>Before</h4>
       <img src={beforePath} />
     </div>
     <div>
       <h4>After</h4>
       <img src={afterPath} />
     </div>
   </div>
   ```

5. **Step Navigation**: EvidencePanel should show:
   - Current step indicator: "Step 2 of 5"
   - Prev/Next buttons
   - Or dropdown to jump to any step

6. **Performance**: For runs with many steps, lazy-load evidence. Only fetch evidence for selected step, not all steps upfront.

### Testing

**Test File Locations**:
- `packages/ux/tests/components/StarButton.test.tsx`
- `packages/ux/tests/components/StepTimeline.test.tsx`
- `packages/ux/tests/components/ScenarioListPanel.test.tsx`
- `packages/ux/tests/hooks/useSteps.test.ts`

**Testing Framework**: Vitest with @testing-library/react [Source: architecture/15-testing-strategy.md]

**Test Patterns**:
```typescript
describe('StarButton', () => {
  it('renders filled star when starred', () => {
    render(<StarButton starred={true} onClick={() => {}} />);
    expect(screen.getByRole('button')).toHaveClass('text-yellow-400');
  });

  it('calls onClick when clicked', () => {
    const onClick = vi.fn();
    render(<StarButton starred={false} onClick={onClick} />);
    fireEvent.click(screen.getByRole('button'));
    expect(onClick).toHaveBeenCalled();
  });
});

describe('StepTimeline', () => {
  const steps = [
    { id: '01', status: 'pass', duration: 5000 },
    { id: '02', status: 'pass', duration: 3000 },
    { id: '03', status: 'fail', duration: 2000, error: 'Not found' },
  ];

  it('renders correct number of step indicators', () => {
    render(<StepTimeline steps={steps} selectedStep="01" onSelectStep={() => {}} />);
    expect(screen.getAllByRole('button')).toHaveLength(3);
  });

  it('shows fail indicator for failed step', () => {
    render(<StepTimeline steps={steps} selectedStep="01" onSelectStep={() => {}} />);
    expect(screen.getByText('03')).toHaveClass('bg-red-500');
  });
});

describe('ScenarioListPanel', () => {
  it('shows starred scenarios first', () => {
    const scenarios = [
      { slug: 'a', title: 'A', starred: false },
      { slug: 'b', title: 'B', starred: true },
    ];
    render(<ScenarioListPanel scenarios={scenarios} ... />);
    const items = screen.getAllByRole('listitem');
    expect(items[0]).toHaveTextContent('B'); // Starred first
  });

  it('shows step count badge', () => {
    const scenarios = [{ slug: 'test', stepCount: 5, ... }];
    render(<ScenarioListPanel scenarios={scenarios} ... />);
    expect(screen.getByText('5 steps')).toBeInTheDocument();
  });
});
```

## Implementation Notes

### Deviations from Original Spec (discovered during testing)

1. **`'running'` status added to RunSummary** - Dashboard needed to display in-progress runs, not just pass/fail. Added `'running'` to StatusType and StatusBadge.

2. **`projectPath` parameter for dashboard tools** - When MCP is called from a different repo, `process.cwd()` returns the wrong path. Added `projectPath` to openDashboard, closeDashboard, getDashboardStatus.

3. **`startedAt` field and optional `completedAt`** - Runs in progress have startedAt but not completedAt. Made completedAt optional in RunSummary.

4. **v1/v2 backward compatibility** - DataService handles both flat evidence (v1) and per-step evidence (v2) structures. parseEvidence supports both `step-01-action.png` and `step-01/evidence/name.png` formats.

5. **Scenario display fix** - Dashboard wasn't showing scenarios with only `meta.yaml` (v2 structure). Changed condition from `if (!scenario)` to `if (!meta && !scenario)`.

6. **Evidence recording fix** - `isRunCompleted` was checking file existence, not status value. Runs with `status: 'running'` were incorrectly blocked from evidence recording.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-18 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-19 | 1.1 | Marked complete, added implementation notes | Course Correction |
