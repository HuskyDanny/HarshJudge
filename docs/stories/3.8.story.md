# Story 3.8: Implement Screenshot Timeline Viewer

## Status

Done

## Story

**As a** dashboard user,
**I want** to view screenshots from a test run in timeline order,
**so that** I can visually trace the test execution step by step.

## Acceptance Criteria

1. Run Detail view shows horizontal timeline of steps
2. Each step represented as thumbnail with step number
3. Clicking thumbnail shows full-size screenshot in main area
4. Step status indicated on thumbnail: green border (pass), red (fail)
5. Current step highlighted in timeline
6. Arrow keys navigate between steps
7. Step metadata shown below screenshot: action, duration, URL
8. Failed step shows error message overlay on screenshot
9. Screenshot zoom: click to toggle fit-to-width vs actual size
10. Performance: thumbnails lazy-loaded, full images loaded on demand

## Tasks / Subtasks

- [x] Task 1: Create RunDetailPanel component (AC: 1, 5)
  - [x] Create `src/components/panels/RunDetailPanel.tsx`
  - [x] Accept runId and scenarioSlug props
  - [x] Use useRunDetail hook for data
  - [x] Layout: timeline at top, main screenshot area below
  - [x] Track currentStepIndex state

- [x] Task 2: Create StepTimeline component (AC: 1, 2, 4, 5)
  - [x] Create `src/components/detail/StepTimeline.tsx`
  - [x] Horizontal scrollable list of step thumbnails
  - [x] Step number overlay on each thumbnail
  - [x] Border color based on step status (green/red)
  - [x] Highlight current step with ring/border

- [x] Task 3: Create StepThumbnail component (AC: 2, 4, 10)
  - [x] Create `src/components/detail/StepThumbnail.tsx`
  - [x] Lazy load thumbnail images
  - [x] Show step number badge
  - [x] Status indicator border
  - [x] Click handler for selection

- [x] Task 4: Create ScreenshotViewer component (AC: 3, 8, 9)
  - [x] Create `src/components/detail/ScreenshotViewer.tsx`
  - [x] Display full-size screenshot
  - [x] Toggle fit-to-width vs actual size on click
  - [x] Error overlay for failed steps
  - [x] Loading state while image loads

- [x] Task 5: Create StepMetadata component (AC: 7)
  - [x] Create `src/components/detail/StepMetadata.tsx`
  - [x] Display action performed, duration, URL
  - [x] Format duration with formatDuration utility

- [x] Task 6: Add keyboard navigation (AC: 6)
  - [x] Integrate useKeyboardNavigation hook
  - [x] Left/Right arrow keys change step
  - [x] Focus management for timeline

- [x] Task 7: Integrate with App.tsx (AC: 1)
  - [x] Add selectedRun state to App
  - [x] Conditionally render RunDetailPanel when run selected
  - [x] Add back navigation to scenario detail

- [x] Task 8: Write tests (AC: all)
  - [x] Create `tests/components/panels/RunDetailPanel.test.tsx`
  - [x] Create `tests/components/detail/StepTimeline.test.tsx`
  - [x] Create `tests/components/detail/ScreenshotViewer.test.tsx`

## Dev Notes

### Previous Story Insights
- Story 3.2 created useRunDetail hook and RunDetail type
- Story 3.7 created RunHistoryList with onRunSelect callback
- Story 3.4 created useKeyboardNavigation hook
- formatDuration utility available in src/lib/parsers.ts

### Data Structure
[Source: Story 3.2 - DataService.ts, @harshjudge/shared]

```typescript
interface RunDetail {
  runId: string;
  scenarioSlug: string;
  result: RunResult | null;
  evidencePaths: string[];  // Paths to screenshot files
}

interface RunResult {
  runId: string;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  failedStep: number | null;
  errorMessage: string | null;
}
```

### Evidence File Naming Convention
Evidence files follow the pattern: `step-{number}-{action}.png`
- `step-01-navigate.png`
- `step-02-click.png`
- `step-03-fill.png`

Metadata files: `step-{number}-{action}.meta.json`
```json
{
  "stepNumber": 1,
  "action": "navigate",
  "url": "https://example.com",
  "duration": 1500,
  "status": "pass"
}
```

### Component Architecture

```typescript
// packages/ux/src/components/panels/RunDetailPanel.tsx
interface RunDetailPanelProps {
  projectPath: string;
  scenarioSlug: string;
  runId: string;
  onBack: () => void;
}

export const RunDetailPanel: FC<RunDetailPanelProps> = ({
  projectPath,
  scenarioSlug,
  runId,
  onBack,
}) => {
  const { runDetail, loading, error } = useRunDetail(projectPath, scenarioSlug, runId);
  const [currentStepIndex, setCurrentStepIndex] = useState(0);
  const [isZoomed, setIsZoomed] = useState(false);

  // Parse evidence paths to extract step info
  const steps = useMemo(() => parseEvidencePaths(runDetail?.evidencePaths || []), [runDetail]);

  // Keyboard navigation
  useKeyboardNavigation({
    items: steps,
    selectedIndex: currentStepIndex,
    onSelect: setCurrentStepIndex,
    orientation: 'horizontal',
  });

  return (
    <div className="flex flex-col h-full">
      {/* Back button and header */}
      <header className="p-4 border-b border-gray-700 flex items-center gap-4">
        <button onClick={onBack} className="text-gray-400 hover:text-white">
          ‚Üê Back to scenario
        </button>
        <h2 className="text-lg font-medium">Run #{runId.slice(0, 8)}</h2>
        {runDetail?.result && (
          <StatusBadge status={runDetail.result.status} showLabel />
        )}
      </header>

      {/* Timeline */}
      <StepTimeline
        steps={steps}
        currentIndex={currentStepIndex}
        onStepSelect={setCurrentStepIndex}
        failedStep={runDetail?.result?.failedStep}
      />

      {/* Main screenshot area */}
      <div className="flex-1 overflow-hidden">
        {steps[currentStepIndex] && (
          <>
            <ScreenshotViewer
              imagePath={steps[currentStepIndex].path}
              isZoomed={isZoomed}
              onToggleZoom={() => setIsZoomed(!isZoomed)}
              errorMessage={
                runDetail?.result?.failedStep === currentStepIndex + 1
                  ? runDetail?.result?.errorMessage
                  : null
              }
            />
            <StepMetadata step={steps[currentStepIndex]} />
          </>
        )}
      </div>
    </div>
  );
};
```

### StepTimeline Component
```typescript
// packages/ux/src/components/detail/StepTimeline.tsx
interface Step {
  number: number;
  path: string;
  action: string;
  thumbnailPath?: string;
}

interface StepTimelineProps {
  steps: Step[];
  currentIndex: number;
  onStepSelect: (index: number) => void;
  failedStep: number | null;
}

export const StepTimeline: FC<StepTimelineProps> = ({
  steps,
  currentIndex,
  onStepSelect,
  failedStep,
}) => {
  return (
    <div className="flex gap-2 p-4 overflow-x-auto bg-gray-800 border-b border-gray-700">
      {steps.map((step, index) => (
        <StepThumbnail
          key={step.number}
          step={step}
          isSelected={index === currentIndex}
          isFailed={step.number === failedStep}
          onClick={() => onStepSelect(index)}
        />
      ))}
    </div>
  );
};
```

### StepThumbnail Component
```typescript
// packages/ux/src/components/detail/StepThumbnail.tsx
interface StepThumbnailProps {
  step: Step;
  isSelected: boolean;
  isFailed: boolean;
  onClick: () => void;
}

export const StepThumbnail: FC<StepThumbnailProps> = ({
  step,
  isSelected,
  isFailed,
  onClick,
}) => {
  const [loaded, setLoaded] = useState(false);

  const borderClass = isFailed
    ? 'border-red-500'
    : 'border-green-500';

  const ringClass = isSelected
    ? 'ring-2 ring-blue-500'
    : '';

  return (
    <button
      onClick={onClick}
      className={`
        relative w-24 h-16 rounded overflow-hidden
        border-2 ${borderClass} ${ringClass}
        transition-all duration-150
        hover:opacity-80
      `}
    >
      {/* Lazy loaded thumbnail */}
      <img
        src={step.thumbnailPath || step.path}
        alt={`Step ${step.number}: ${step.action}`}
        className={`w-full h-full object-cover ${loaded ? '' : 'opacity-0'}`}
        loading="lazy"
        onLoad={() => setLoaded(true)}
      />

      {/* Step number badge */}
      <span className="absolute top-1 left-1 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded">
        {step.number}
      </span>

      {/* Loading placeholder */}
      {!loaded && (
        <div className="absolute inset-0 bg-gray-700 animate-pulse" />
      )}
    </button>
  );
};
```

### ScreenshotViewer Component
```typescript
// packages/ux/src/components/detail/ScreenshotViewer.tsx
interface ScreenshotViewerProps {
  imagePath: string;
  isZoomed: boolean;
  onToggleZoom: () => void;
  errorMessage: string | null;
}

export const ScreenshotViewer: FC<ScreenshotViewerProps> = ({
  imagePath,
  isZoomed,
  onToggleZoom,
  errorMessage,
}) => {
  const [loading, setLoading] = useState(true);

  return (
    <div
      className={`
        relative flex-1 overflow-auto bg-gray-900
        ${isZoomed ? 'cursor-zoom-out' : 'cursor-zoom-in'}
      `}
      onClick={onToggleZoom}
    >
      {loading && (
        <div className="absolute inset-0 flex items-center justify-center">
          <span className="text-gray-500">Loading screenshot...</span>
        </div>
      )}

      <img
        src={imagePath}
        alt="Test step screenshot"
        className={`
          ${loading ? 'opacity-0' : ''}
          ${isZoomed ? '' : 'max-w-full max-h-full object-contain mx-auto'}
        `}
        onLoad={() => setLoading(false)}
      />

      {/* Error overlay */}
      {errorMessage && (
        <div className="absolute bottom-0 left-0 right-0 bg-red-900/90 p-4 text-white">
          <h4 className="font-medium mb-1">Step Failed</h4>
          <p className="text-sm text-red-200">{errorMessage}</p>
        </div>
      )}
    </div>
  );
};
```

### StepMetadata Component
```typescript
// packages/ux/src/components/detail/StepMetadata.tsx
interface StepMetadataProps {
  step: {
    number: number;
    action: string;
    url?: string;
    duration?: number;
  };
}

export const StepMetadata: FC<StepMetadataProps> = ({ step }) => {
  return (
    <div className="p-4 bg-gray-800 border-t border-gray-700">
      <div className="flex items-center gap-6 text-sm">
        <span className="text-gray-400">
          Step {step.number}: <span className="text-white font-medium">{step.action}</span>
        </span>
        {step.duration && (
          <span className="text-gray-500">
            {formatDuration(step.duration)}
          </span>
        )}
        {step.url && (
          <span className="text-gray-500 truncate max-w-md" title={step.url}>
            {step.url}
          </span>
        )}
      </div>
    </div>
  );
};
```

### Integration with App.tsx
```typescript
// Update App.tsx
const AppContent: FC = () => {
  // ... existing state
  const [selectedRun, setSelectedRun] = useState<string | null>(null);

  // Clear run selection when scenario changes
  const handleScenarioSelect = (slug: string) => {
    setSelectedScenario(slug);
    setSelectedRun(null);
  };

  // Back from run detail to scenario detail
  const handleBackToScenario = () => {
    setSelectedRun(null);
  };

  return (
    <ThreeColumnLayout
      rightPanel={
        selectedRun ? (
          <RunDetailPanel
            projectPath={selectedProject!}
            scenarioSlug={selectedScenario!}
            runId={selectedRun}
            onBack={handleBackToScenario}
          />
        ) : (
          <ScenarioDetailPanel
            projectPath={selectedProject}
            scenarioSlug={selectedScenario}
            onRunSelect={setSelectedRun}
          />
        )
      }
    />
  );
};
```

### Utility: Parse Evidence Paths
```typescript
// packages/ux/src/lib/parseEvidence.ts
interface ParsedStep {
  number: number;
  action: string;
  path: string;
}

export function parseEvidencePaths(paths: string[]): ParsedStep[] {
  return paths
    .filter(p => p.endsWith('.png') || p.endsWith('.jpg'))
    .map(path => {
      const filename = path.split('/').pop() || '';
      const match = filename.match(/step-(\d+)-(.+)\.(png|jpg)$/);
      if (!match) {
        return { number: 0, action: 'unknown', path };
      }
      return {
        number: parseInt(match[1], 10),
        action: match[2],
        path,
      };
    })
    .sort((a, b) => a.number - b.number);
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story draft | SM Agent |
