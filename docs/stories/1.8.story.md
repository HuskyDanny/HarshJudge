# Story 1.8: Implement `completeRun` MCP Tool

## Status

Done

## Story

**As a** Claude Code user,
**I want** to complete a test run with results,
**so that** the run is finalized and statistics are updated.

## Acceptance Criteria

1. `completeRun` tool registered in MCP server with proper schema
2. Tool accepts parameters: `runId`, `status`, `duration`, `failedStep` (optional), `errorMessage` (optional)
3. Tool validates run exists and is not already completed
4. Tool writes `result.json` with run outcome and details
5. Tool updates scenario `meta.yaml` with new statistics
6. Tool returns updated scenario statistics
7. Unit tests verify result writing and stats calculation

## Tasks / Subtasks

- [x] **Task 1: Implement completeRun handler**
- [x] **Task 2: Update mcp-server exports**
- [x] **Task 3: Write unit tests**
- [x] **Task 4: Verify build and tests pass**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story | SM Agent (Bob) |

---

## Dev Agent Record

**Implementation Date:** 2025-12-04

**Files Created/Modified:**
- `packages/mcp-server/src/handlers/complete-run.ts` (NEW) - Handler implementation
- `packages/mcp-server/tests/handlers/complete-run.test.ts` (NEW) - 19 unit tests
- `packages/mcp-server/src/services/file-system-service.ts` (MODIFIED) - Added listFiles() method
- `packages/shared/src/schemas/mcp-schemas.ts` (MODIFIED) - Added CompleteRunParamsSchema
- `packages/shared/src/types/mcp-types.ts` (MODIFIED) - Added CompleteRunResult type

**Implementation Details:**
- Validates run exists and is not already completed
- Validates status is 'pass' or 'fail'
- Validates failedStep and errorMessage are provided for failed runs
- Counts evidence files in run directory
- Writes result.json with complete run data
- Updates scenario meta.yaml with new statistics (totalRuns, passCount, failCount, avgDuration, lastRun, lastResult)
- Calculates rolling average duration correctly

**Test Coverage:** 19 tests covering pass/fail scenarios, statistics updates, validation errors, and edge cases

---

## QA Results

**QA Date:** 2025-12-04
**Status:** PASSED

- All 19 unit tests pass
- TypeScript compilation successful
- ESLint validation passed
- All acceptance criteria met
