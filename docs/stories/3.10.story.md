# Story 3.10: Implement Dashboard Server

## Status

Done

## Story

**As a** developer,
**I want** to serve the dashboard from a simple HTTP server,
**so that** I can view test results in my browser without needing to set up a separate web server.

## Acceptance Criteria

1. CLI command `harshjudge dashboard` starts local server
2. Server serves static files from the built UX package
3. Default port 3000, configurable via --port flag
4. Opens browser automatically (optional --no-open flag)
5. Serves at project root to read .harshJudge directory
6. Shows server URL in terminal output
7. Graceful shutdown on Ctrl+C
8. Hot reload when project files change (optional)

## Tasks / Subtasks

- [x] Task 1: Create DashboardServer class (AC: 1, 2, 5)
  - [x] Create `src/server/DashboardServer.ts` in ux package
  - [x] Use http module to serve static files
  - [x] Serve built assets from dist/
  - [x] Handle SPA routing (fallback to index.html)

- [x] Task 2: Add CLI command (AC: 1, 6)
  - [x] Add `serve.ts` CLI script in ux package
  - [x] Show server URL on startup
  - [x] Display clear startup message

- [x] Task 3: Configure port options (AC: 3)
  - [x] Default to port 3000
  - [x] Support --port flag
  - [x] Handle port-in-use gracefully

- [x] Task 4: Auto-open browser (AC: 4)
  - [x] Open default browser on startup
  - [x] Support --no-open flag to disable
  - [x] Cross-platform browser opening

- [x] Task 5: Graceful shutdown (AC: 7)
  - [x] Handle SIGINT (Ctrl+C)
  - [x] Clean shutdown message
  - [x] Close all connections

- [ ] Task 6: File watching (AC: 8) - OPTIONAL, not implemented
  - [ ] Optional live reload
  - [ ] WebSocket connection for updates
  - [ ] --watch flag to enable

- [x] Task 7: Write tests (AC: all)
  - [x] Create `tests/server/DashboardServer.test.ts`
  - [x] Test server startup/shutdown
  - [x] Test static file serving
  - [x] Test CORS headers
  - [x] Test security (directory traversal blocking)

## Dev Notes

### Previous Story Insights
- Story 3.1-3.9 created complete UX dashboard
- FileWatcherService exists for file watching
- UX package builds to dist/ directory

### Server Architecture

```typescript
// packages/ux/src/server/DashboardServer.ts
import { createServer, IncomingMessage, ServerResponse } from 'http';
import { readFile, stat } from 'fs/promises';
import { join, extname } from 'path';
import { AddressInfo } from 'net';

interface DashboardServerOptions {
  port?: number;
  projectPath?: string;
  autoOpen?: boolean;
  watch?: boolean;
}

export class DashboardServer {
  private server: ReturnType<typeof createServer> | null = null;
  private port: number;
  private projectPath: string;
  private distPath: string;

  constructor(options: DashboardServerOptions = {}) {
    this.port = options.port ?? 3000;
    this.projectPath = options.projectPath ?? process.cwd();
    this.distPath = join(__dirname, '../../dist');
  }

  async start(): Promise<number> {
    return new Promise((resolve, reject) => {
      this.server = createServer(this.handleRequest.bind(this));

      this.server.on('error', (err: NodeJS.ErrnoException) => {
        if (err.code === 'EADDRINUSE') {
          reject(new Error(`Port ${this.port} is already in use`));
        } else {
          reject(err);
        }
      });

      this.server.listen(this.port, () => {
        const address = this.server?.address() as AddressInfo;
        resolve(address.port);
      });
    });
  }

  async stop(): Promise<void> {
    return new Promise((resolve) => {
      if (this.server) {
        this.server.close(() => resolve());
      } else {
        resolve();
      }
    });
  }

  private async handleRequest(req: IncomingMessage, res: ServerResponse) {
    const url = req.url || '/';

    // API routes for file system access
    if (url.startsWith('/api/')) {
      return this.handleApiRequest(url, req, res);
    }

    // Static file serving
    let filePath = join(this.distPath, url === '/' ? 'index.html' : url);

    try {
      const stats = await stat(filePath);
      if (stats.isDirectory()) {
        filePath = join(filePath, 'index.html');
      }

      const content = await readFile(filePath);
      const contentType = this.getContentType(filePath);

      res.writeHead(200, { 'Content-Type': contentType });
      res.end(content);
    } catch {
      // SPA fallback - serve index.html for non-file routes
      try {
        const indexContent = await readFile(join(this.distPath, 'index.html'));
        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end(indexContent);
      } catch {
        res.writeHead(404);
        res.end('Not Found');
      }
    }
  }

  private async handleApiRequest(url: string, req: IncomingMessage, res: ServerResponse) {
    // Proxy file system requests to DataService
    res.writeHead(501);
    res.end('API not implemented');
  }

  private getContentType(filePath: string): string {
    const ext = extname(filePath).toLowerCase();
    const types: Record<string, string> = {
      '.html': 'text/html',
      '.js': 'application/javascript',
      '.css': 'text/css',
      '.json': 'application/json',
      '.png': 'image/png',
      '.jpg': 'image/jpeg',
      '.svg': 'image/svg+xml',
      '.ico': 'image/x-icon',
    };
    return types[ext] || 'application/octet-stream';
  }
}
```

### CLI Integration

```typescript
// packages/cli/src/commands/dashboard.ts
import { DashboardServer } from '@harshjudge/ux/server';
import open from 'open';

export async function dashboardCommand(options: {
  port?: number;
  open?: boolean;
}) {
  const server = new DashboardServer({
    port: options.port,
    projectPath: process.cwd(),
  });

  try {
    const port = await server.start();
    const url = `http://localhost:${port}`;

    console.log(`\nðŸš€ HarshJudge Dashboard running at ${url}\n`);

    if (options.open !== false) {
      await open(url);
    }

    // Handle shutdown
    process.on('SIGINT', async () => {
      console.log('\nShutting down...');
      await server.stop();
      process.exit(0);
    });
  } catch (err) {
    console.error('Failed to start dashboard:', err);
    process.exit(1);
  }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story draft | SM Agent |
| 2025-12-07 | 1.1 | Implementation complete - 21 server tests passing | Dev Agent |
| 2025-12-07 | 1.2 | QA Review passed - Story marked as Done | QA Agent |
