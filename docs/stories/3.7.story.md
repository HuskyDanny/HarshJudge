# Story 3.7: Implement Scenario Detail View

## Status

Done

## Story

**As a** dashboard user,
**I want** to see scenario details including content and run history,
**so that** I can understand what the test does and how it has performed.

## Acceptance Criteria

1. Detail panel shows scenario information when scenario selected
2. Scenario content section: rendered Markdown of `scenario.md`
3. Statistics section: total runs, pass/fail counts, average duration
4. Run history section: list of recent runs (last 10)
5. Each run row shows: timestamp, result, duration, click to expand
6. Clicking a run navigates to Run Detail view
7. "No runs yet" empty state for scenarios never executed
8. Scenario metadata displayed: created date, last updated, tags

## Tasks / Subtasks

- [x] Task 1: Create Markdown renderer component (AC: 2)
  - [x] Created `src/components/common/MarkdownContent.tsx`
  - [x] Custom parseMarkdown function (no external deps)
  - [x] Tailwind styling for headers, lists, code, links
  - [x] Support for code blocks, bold, italic, links

- [x] Task 2: Create ScenarioStats component (AC: 3)
  - [x] Created `src/components/detail/ScenarioStats.tsx`
  - [x] Display total runs, pass count, fail count
  - [x] Average duration using formatDuration utility
  - [x] Visual pass rate bar with color coding

- [x] Task 3: Create RunHistoryList component (AC: 4, 5, 6, 7)
  - [x] Created `src/components/detail/RunHistoryList.tsx`
  - [x] Display list of recent runs
  - [x] Each row: run number, timestamp, status badge, duration
  - [x] Click/keyboard handler for navigation
  - [x] Empty state when no runs

- [x] Task 4: Create ScenarioDetailPanel component (AC: 1, 8)
  - [x] Created `src/components/panels/ScenarioDetailPanel.tsx`
  - [x] Uses useScenarioDetail hook for data
  - [x] Composes MarkdownContent, ScenarioStats, RunHistoryList
  - [x] Shows tags with TagChip components

- [x] Task 5: Integrate with App.tsx (AC: 1, 6)
  - [x] Replaced DetailPanelPlaceholder with ScenarioDetailPanel
  - [x] Connected useScenarioDetail hook
  - [x] Prepared onRunSelect callback for future use

- [x] Task 6: Write tests (AC: all)
  - [x] Created `tests/components/detail/ScenarioStats.test.tsx` (12 tests)
  - [x] Created `tests/components/detail/RunHistoryList.test.tsx` (12 tests)
  - [x] Total: 146 tests passing

## Dev Notes

### Previous Story Insights
- Story 3.2 created useScenarioDetail hook and ScenarioDetail type
- Story 3.5 created StatusBadge component
- Story 3.6 created TagChip and formatRelativeTime utility
- formatDuration utility exists in src/lib/parsers.ts

### Data Structure
[Source: Story 3.2 - DataService.ts, @harshjudge/shared]

```typescript
interface ScenarioDetail {
  slug: string;
  title: string;
  tags: string[];
  content: string;  // Markdown content from scenario.md
  meta: ScenarioMeta;
  recentRuns: RunSummary[];
}

interface ScenarioMeta {
  totalRuns: number;
  passCount: number;
  failCount: number;
  lastRun: string | null;
  lastResult: 'pass' | 'fail' | null;
  avgDuration: number;  // milliseconds
}

interface RunSummary {
  id: string;
  runNumber: number;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  errorMessage: string | null;
}
```

### Component Architecture

```typescript
// packages/ux/src/components/panels/ScenarioDetailPanel.tsx
import { type FC } from 'react';
import { useScenarioDetail } from '@/hooks';
import { MarkdownContent } from '../common/MarkdownContent';
import { ScenarioStats } from '../detail/ScenarioStats';
import { RunHistoryList } from '../detail/RunHistoryList';
import { TagChip } from '../common/TagChip';
import { EmptyState, EyeIcon } from '../common/EmptyState';

interface ScenarioDetailPanelProps {
  projectPath: string | null;
  scenarioSlug: string | null;
  onRunSelect?: (runId: string) => void;
}

export const ScenarioDetailPanel: FC<ScenarioDetailPanelProps> = ({
  projectPath,
  scenarioSlug,
  onRunSelect,
}) => {
  const { scenario, loading, error } = useScenarioDetail(projectPath, scenarioSlug);

  if (!scenarioSlug) {
    return (
      <EmptyState
        icon={<EyeIcon />}
        title="Select a scenario"
        description="Choose a scenario to view its details"
      />
    );
  }

  if (loading) {
    return <LoadingState />;
  }

  if (error || !scenario) {
    return <EmptyState title="Error" description={error || 'Scenario not found'} />;
  }

  return (
    <div className="h-full overflow-y-auto p-6">
      {/* Header with title and tags */}
      <header className="mb-6">
        <h2 className="text-xl font-semibold text-white mb-2">
          {scenario.title}
        </h2>
        {scenario.tags.length > 0 && (
          <div className="flex flex-wrap gap-2">
            {scenario.tags.map((tag) => (
              <TagChip key={tag} tag={tag} size="md" />
            ))}
          </div>
        )}
      </header>

      {/* Statistics */}
      <ScenarioStats meta={scenario.meta} />

      {/* Scenario content (Markdown) */}
      <section className="mt-6">
        <h3 className="text-sm font-medium text-gray-400 mb-2">Scenario Steps</h3>
        <MarkdownContent content={scenario.content} />
      </section>

      {/* Run history */}
      <section className="mt-6">
        <h3 className="text-sm font-medium text-gray-400 mb-2">Recent Runs</h3>
        <RunHistoryList
          runs={scenario.recentRuns}
          onRunSelect={onRunSelect}
        />
      </section>
    </div>
  );
};
```

### MarkdownContent Component
```typescript
// packages/ux/src/components/common/MarkdownContent.tsx
import { type FC } from 'react';
import ReactMarkdown from 'react-markdown';

interface MarkdownContentProps {
  content: string;
}

export const MarkdownContent: FC<MarkdownContentProps> = ({ content }) => {
  return (
    <div className="prose prose-invert prose-sm max-w-none">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
};
```

### ScenarioStats Component
```typescript
// packages/ux/src/components/detail/ScenarioStats.tsx
import { type FC } from 'react';
import { type ScenarioMeta } from '@harshjudge/shared';
import { formatDuration } from '@/lib';

interface ScenarioStatsProps {
  meta: ScenarioMeta;
}

export const ScenarioStats: FC<ScenarioStatsProps> = ({ meta }) => {
  const passRate = meta.totalRuns > 0
    ? Math.round((meta.passCount / meta.totalRuns) * 100)
    : 0;

  return (
    <div className="grid grid-cols-4 gap-4 p-4 bg-gray-800 rounded-lg">
      <StatCard label="Total Runs" value={meta.totalRuns.toString()} />
      <StatCard label="Passed" value={meta.passCount.toString()} color="green" />
      <StatCard label="Failed" value={meta.failCount.toString()} color="red" />
      <StatCard label="Avg Duration" value={formatDuration(meta.avgDuration)} />
    </div>
  );
};

const StatCard: FC<{ label: string; value: string; color?: 'green' | 'red' }> = ({
  label,
  value,
  color,
}) => {
  const colorClass = color === 'green' ? 'text-green-400'
    : color === 'red' ? 'text-red-400'
    : 'text-white';

  return (
    <div className="text-center">
      <div className={`text-2xl font-bold ${colorClass}`}>{value}</div>
      <div className="text-xs text-gray-500">{label}</div>
    </div>
  );
};
```

### RunHistoryList Component
```typescript
// packages/ux/src/components/detail/RunHistoryList.tsx
import { type FC } from 'react';
import { type RunSummary } from '@harshjudge/shared';
import { StatusBadge } from '../common/StatusBadge';
import { formatRelativeTime, formatDuration } from '@/lib';

interface RunHistoryListProps {
  runs: RunSummary[];
  onRunSelect?: (runId: string) => void;
}

export const RunHistoryList: FC<RunHistoryListProps> = ({ runs, onRunSelect }) => {
  if (runs.length === 0) {
    return (
      <div className="text-sm text-gray-500 py-4 text-center">
        No runs yet. Run this scenario to see results here.
      </div>
    );
  }

  return (
    <ul className="space-y-2">
      {runs.map((run) => (
        <li
          key={run.id}
          className="flex items-center justify-between p-3 bg-gray-800 rounded-lg
                     hover:bg-gray-750 cursor-pointer transition-colors"
          onClick={() => onRunSelect?.(run.id)}
        >
          <div className="flex items-center gap-3">
            <StatusBadge status={run.status} />
            <span className="text-sm text-gray-300">
              {formatRelativeTime(run.completedAt)}
            </span>
          </div>
          <span className="text-sm text-gray-500">
            {formatDuration(run.duration)}
          </span>
        </li>
      ))}
    </ul>
  );
};
```

### Dependencies
- react-markdown: For Markdown rendering
- @tailwindcss/typography: For prose classes (if not already installed)

### Integration with App.tsx
```typescript
// Update App.tsx
import { ScenarioDetailPanel } from '@/components/panels/ScenarioDetailPanel';

// In AppContent:
<ThreeColumnLayout
  rightPanel={
    <ScenarioDetailPanel
      projectPath={selectedProject}
      scenarioSlug={selectedScenario}
      onRunSelect={setSelectedRun}
    />
  }
/>
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 1.0 | Initial story draft | SM Agent |
