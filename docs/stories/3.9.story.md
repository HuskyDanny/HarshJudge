# Story 3.9: Implement Log Viewer for Failed Runs

## Status

Done

## Story

**As a** dashboard user,
**I want** to view detailed error logs when a test run fails,
**so that** I can understand what went wrong and debug the issue.

## Acceptance Criteria

1. Failed runs show expandable log section in run detail view
2. Log content displays with syntax highlighting for readability
3. Error messages highlighted in red with line numbers
4. Stack traces displayed with proper formatting
5. Log section collapsible/expandable to save space
6. Copy to clipboard button for log content
7. Search/filter within log content
8. Auto-scroll to first error when log opens

## Tasks / Subtasks

- [x] Task 1: Create LogViewer component (AC: 1, 2, 3, 4)
  - [x] Create `src/components/detail/LogViewer.tsx`
  - [x] Display log content with line numbers
  - [x] Syntax highlighting for errors (red background)
  - [x] Stack trace formatting with monospace font

- [x] Task 2: Create LogSection component (AC: 1, 5)
  - [x] Create `src/components/detail/LogSection.tsx`
  - [x] Collapsible panel with expand/collapse button
  - [x] Default collapsed state, expanded when error present

- [x] Task 3: Add clipboard functionality (AC: 6)
  - [x] Create clipboard utility function
  - [x] Copy button in LogViewer header
  - [x] Visual feedback on copy success

- [x] Task 4: Add search functionality (AC: 7)
  - [x] Search input field in LogViewer
  - [x] Highlight matching terms
  - [x] Navigate between matches

- [x] Task 5: Auto-scroll to error (AC: 8)
  - [x] Detect first error line
  - [x] Scroll to error on expand
  - [x] Visual indicator for error position

- [x] Task 6: Integrate with RunDetailPanel (AC: 1)
  - [x] Add LogSection below StepMetadata
  - [x] Pass error data from runDetail
  - [x] Show only for failed runs

- [x] Task 7: Write tests (AC: all)
  - [x] Create `tests/components/detail/LogViewer.test.tsx`
  - [x] Create `tests/components/detail/LogSection.test.tsx`

## Dev Notes

### Previous Story Insights
- Story 3.8 created RunDetailPanel with screenshot viewer
- RunDetail type includes errorMessage field
- Story 3.2 defined RunResult with errorMessage and failedStep

### Data Structure
[Source: Story 3.2 - DataService.ts]

```typescript
interface RunResult {
  runId: string;
  status: 'pass' | 'fail';
  duration: number;
  completedAt: string;
  failedStep: number | null;
  errorMessage: string | null;
}
```

### Component Architecture

```typescript
// packages/ux/src/components/detail/LogViewer.tsx
interface LogViewerProps {
  content: string;
  errorLines?: number[];
  onCopy?: () => void;
}

export const LogViewer: FC<LogViewerProps> = ({
  content,
  errorLines = [],
  onCopy,
}) => {
  const [searchTerm, setSearchTerm] = useState('');
  const logRef = useRef<HTMLPreElement>(null);

  // Split content into lines
  const lines = content.split('\n');

  return (
    <div className="bg-gray-900 rounded-lg overflow-hidden">
      {/* Header with search and copy */}
      <div className="flex items-center gap-2 p-2 bg-gray-800 border-b border-gray-700">
        <input
          type="text"
          placeholder="Search logs..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="flex-1 bg-gray-700 text-sm px-2 py-1 rounded"
        />
        <button onClick={onCopy} className="text-gray-400 hover:text-white">
          Copy
        </button>
      </div>

      {/* Log content */}
      <pre
        ref={logRef}
        className="p-4 overflow-auto max-h-96 text-sm font-mono"
      >
        {lines.map((line, i) => (
          <div
            key={i}
            className={`
              flex gap-4
              ${errorLines.includes(i) ? 'bg-red-900/30 text-red-300' : 'text-gray-300'}
              ${searchTerm && line.toLowerCase().includes(searchTerm.toLowerCase()) ? 'bg-yellow-900/30' : ''}
            `}
          >
            <span className="text-gray-600 select-none w-8 text-right">
              {i + 1}
            </span>
            <span className="flex-1 whitespace-pre-wrap break-all">
              {line}
            </span>
          </div>
        ))}
      </pre>
    </div>
  );
};
```

### LogSection Component

```typescript
// packages/ux/src/components/detail/LogSection.tsx
interface LogSectionProps {
  title: string;
  content: string | null;
  defaultExpanded?: boolean;
}

export const LogSection: FC<LogSectionProps> = ({
  title,
  content,
  defaultExpanded = false,
}) => {
  const [expanded, setExpanded] = useState(defaultExpanded);

  if (!content) return null;

  return (
    <div className="border border-gray-700 rounded-lg overflow-hidden">
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center justify-between p-3 bg-gray-800 hover:bg-gray-750"
      >
        <span className="font-medium text-sm">{title}</span>
        <ChevronIcon expanded={expanded} />
      </button>

      {expanded && (
        <LogViewer content={content} />
      )}
    </div>
  );
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story draft | SM Agent |
