# Story 4.1: Implement CLI Entry Point

## Status

Done

## Story

**As a** developer,
**I want** a unified CLI for HarshJudge commands,
**so that** users have a single entry point for all operations.

## Acceptance Criteria

1. CLI implemented with commands: `init`, `dashboard`, `status`
2. `harshjudge init` copies YAML-structured skills (skill.yaml + tasks/ + templates/ + checklists/ + data/) to `.claude/skills/harshjudge/` and initializes project
3. `harshjudge dashboard` starts the dashboard server
4. `harshjudge status` prints quick status to terminal
5. CLI has `--help` for all commands
6. CLI has `--version` flag
7. Proper exit codes for success/failure

## Tasks / Subtasks

- [x] Task 1: Create CLI package structure (AC: 1, 5, 6, 7)
  - [x] Create `packages/cli/` directory with TypeScript configuration
  - [x] Add `package.json` with `bin` entry pointing to compiled CLI
  - [x] Configure `tsconfig.json` extending base config
  - [x] Set up main entry point `src/index.ts` with commander.js
  - [x] Add `--version` flag reading from package.json
  - [x] Add `--help` for main command and subcommands

- [x] Task 2: Implement `init` command (AC: 2)
  - [x] Create `src/commands/init.ts`
  - [x] Copy skills directory structure from installed package to `.claude/skills/harshjudge/`
  - [x] Skills structure to copy: `skill.yaml`, `tasks/`, `templates/`, `checklists/`, `data/`
  - [x] Initialize `.harshJudge/` directory using MCP `initProject` tool or direct file operations
  - [x] Create `.harshJudge/config.yaml` with project name and base URL prompts
  - [x] Handle existing initialization gracefully (warn and skip)
  - [x] Display success message with next steps

- [x] Task 3: Implement `dashboard` command (AC: 3)
  - [x] Create `src/commands/dashboard.ts`
  - [x] Import and use `DashboardServer` from `@harshjudge/ux`
  - [x] Support `--port` flag (default: 3000)
  - [x] Support `--no-open` flag to disable auto browser opening
  - [x] Display server URL and shutdown instructions
  - [x] Handle graceful shutdown on SIGINT/SIGTERM

- [x] Task 4: Implement `status` command (AC: 4)
  - [x] Create `src/commands/status.ts`
  - [x] Read `.harshJudge/` directory structure
  - [x] Parse scenario meta.yaml files for status aggregation
  - [x] Display formatted terminal output with:
    - Project name and initialization status
    - Total scenarios count
    - Pass/fail/never-run breakdown
    - Last run timestamp
  - [x] Handle uninitialized project gracefully

- [x] Task 5: Configure build and distribution (AC: 1, 7)
  - [x] Add build script to compile TypeScript
  - [x] Configure `bin` field in package.json for `harshjudge` command
  - [x] Add shebang line (`#!/usr/bin/env node`) to entry point
  - [x] Ensure proper exit codes (0 for success, 1 for error)
  - [ ] Add postinstall script for npm package consumers (deferred to publishing)

- [x] Task 6: Write unit tests (AC: all)
  - [x] Create `packages/cli/tests/` directory
  - [x] Test init command with mock file system
  - [ ] Test dashboard command startup/shutdown (deferred - requires mock server)
  - [x] Test status command output parsing
  - [x] Test CLI argument parsing (via manual testing)
  - [x] Test exit codes for various scenarios (via manual testing)

## Dev Notes

### Previous Story Insights
- Story 3.10 implemented `DashboardServer` class in `packages/ux/src/server/`
- Server implementation uses Node.js `http` module with static file serving
- `serve.ts` provides CLI argument parsing pattern that can be reused
- Cross-platform browser opening implemented using `os.platform()` detection
- Graceful shutdown pattern with SIGINT/SIGTERM handlers established

### Source Tree Structure
[Source: architecture.md#11-unified-project-structure]
```
HarshJudge/
├── packages/
│   ├── cli/                    # NEW: @harshjudge/cli (this story)
│   │   ├── src/
│   │   │   ├── commands/
│   │   │   │   ├── init.ts
│   │   │   │   ├── dashboard.ts
│   │   │   │   └── status.ts
│   │   │   └── index.ts        # Main CLI entry
│   │   ├── tests/
│   │   ├── package.json
│   │   └── tsconfig.json
│   ├── mcp-server/             # Existing
│   ├── ux/                     # Existing (has DashboardServer)
│   └── shared/                 # Existing (types)
├── skills/
│   └── harshjudge/             # Skills to copy during init
│       ├── skill.yaml
│       ├── tasks/
│       ├── templates/
│       ├── checklists/
│       └── data/
```

### Skills Directory Structure (to be copied by `init`)
[Source: Project filesystem analysis]
```
skills/harshjudge/
├── skill.yaml                  # Main skill definition
├── tasks/
│   ├── setup-project.md
│   ├── analyze-project.md
│   ├── create-scenario.md
│   ├── run-scenario.md
│   └── check-status.md
├── templates/
│   ├── scenario-tmpl.yaml
│   ├── analysis-output-tmpl.md
│   └── status-output-tmpl.md
├── checklists/
│   ├── setup-checklist.md
│   ├── scenario-checklist.md
│   ├── pre-run-checklist.md
│   └── evidence-checklist.md
└── data/
    ├── evidence-types.md
    ├── skill-state-schema.md
    └── error-protocols.md
```

### Tech Stack for CLI
[Source: architecture.md#3-tech-stack]
- **Language:** TypeScript 5.3+
- **Runtime:** Node.js 18+ LTS
- **CLI Framework:** commander.js (recommended) or yargs
- **Package Manager:** pnpm 8+
- **Build:** TypeScript compiler (tsc)

### Existing DashboardServer API
[Source: packages/ux/src/server/DashboardServer.ts]
```typescript
interface DashboardServerOptions {
  port?: number;
  projectPath?: string;
  distPath?: string;
}

class DashboardServer {
  constructor(options: DashboardServerOptions)
  start(): Promise<number>
  stop(): Promise<void>
  getUrl(): string
}
```

### Status Output Format Reference
[Source: architecture.md#data-models]
```typescript
interface ProjectStatus {
  projectName: string;
  scenarioCount: number;
  passing: number;
  failing: number;
  neverRun: number;
  scenarios: ScenarioSummary[];
}
```

### Init Command Behavior
[Source: Epic 4.1 AC#2]
1. Create `.claude/skills/harshjudge/` directory in user's project
2. Copy entire skills structure maintaining directory hierarchy
3. Optionally initialize `.harshJudge/` directory with config
4. Provide clear instructions for Claude Code MCP configuration

### Exit Code Standards
[Source: architecture.md#17-error-handling-strategy]
- `0`: Success
- `1`: General error (invalid args, file not found, etc.)
- Use structured error messages to stderr

### Testing

**Test file location:** `packages/cli/tests/`

**Test standards:**
- Use Vitest as test runner
- Use memfs for file system mocking
- Test each command in isolation
- Test argument parsing edge cases

**Testing frameworks and patterns:**
[Source: architecture.md#15-testing-strategy]
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { vol } from 'memfs';

vi.mock('fs/promises', async () => {
  const memfs = await import('memfs');
  return memfs.fs.promises;
});

describe('init command', () => {
  beforeEach(() => {
    vol.reset();
  });

  it('copies skills to .claude/skills/harshjudge/', async () => {
    // Test implementation
  });
});
```

## Dev Agent Record

### Implementation Summary
- **Date:** 2025-12-07
- **Build Status:** ✅ Passing
- **Test Status:** ✅ 8/8 tests passing

### Files Created
- `packages/cli/package.json` - CLI package configuration with commander.js
- `packages/cli/tsconfig.json` - TypeScript config extending base
- `packages/cli/vitest.config.ts` - Test configuration
- `packages/cli/src/index.ts` - Main CLI entry point with 3 commands
- `packages/cli/src/commands/init.ts` - Project initialization command
- `packages/cli/src/commands/dashboard.ts` - Dashboard server launcher
- `packages/cli/src/commands/status.ts` - Status display command
- `packages/cli/tests/commands/init.test.ts` - Init command tests (4 tests)
- `packages/cli/tests/commands/status.test.ts` - Status command tests (4 tests)

### Files Modified
- `packages/ux/package.json` - Added exports for server modules
- `packages/ux/tsconfig.server.json` - Enabled declaration files
- `packages/ux/src/server/DashboardServer.ts` - Fixed type safety issue

### Verification
```
CLI Help: harshjudge --help ✅
Init Command: Copies skills, creates .harshJudge/ ✅
Dashboard Command: Starts DashboardServer ✅
Status Command: Shows project status ✅
Unit Tests: 8/8 passing ✅
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story draft | SM Agent |
| 2025-12-07 | 1.1 | DEV implementation complete, moved to UnderReview | DEV Agent |
| 2025-12-07 | 1.2 | QA approved - all AC met, marked Done | QA Agent |
