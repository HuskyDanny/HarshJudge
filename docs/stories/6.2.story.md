# Story 6.2: Granular Step Schema

## Status

Done

## Story

**As a** HarshJudge user,
**I want** scenarios to have individual step files with a structured meta.yaml,
**so that** steps are maintainable, reorderable, and clearly scoped.

## Acceptance Criteria

1. New scenario structure:
   ```
   .harshJudge/scenarios/{slug}/
   ├── meta.yaml
   └── steps/
       ├── 01-{step-slug}.md
       ├── 02-{step-slug}.md
       └── ...
   ```
2. `meta.yaml` schema includes:
   ```yaml
   title: "Scenario Title"
   slug: "scenario-slug"
   starred: false          # For filtering important scenarios
   tags: []
   estimatedDuration: 60
   steps:
     - id: "01"
       title: "Navigate to login page"
       file: "01-navigate-to-login.md"
     - id: "02"
       title: "Enter credentials"
       file: "02-enter-credentials.md"
   ```
3. Each step `.md` file contains:
   - Step title and description
   - Expected preconditions
   - Actions to perform
   - Expected outcomes/assertions
4. `starred` field enables scenario filtering (absorbed from Story 5.2)
5. Steps are numbered with zero-padded prefixes (01, 02, ... 99)

## Tasks / Subtasks

- [x] Task 1: Define Step type in shared types (AC: 3, 5)
  - [x] Open `packages/shared/src/types/scenario.ts`
  - [x] Add `Step` interface with id, title, description, preconditions, actions, expectedOutcome
  - [x] Add `StepFile` interface for reading step content
  - [x] Add `StepReference` interface for meta.yaml references (id, title, file)
  - [x] Export new types from `packages/shared/src/index.ts`

- [x] Task 2: Update Scenario and ScenarioMeta types (AC: 2, 4)
  - [x] Add `starred: boolean` field to `Scenario` interface
  - [x] Add `steps: StepReference[]` field to `Scenario` interface
  - [x] Update `ScenarioMeta` to include `starred` and `steps` fields
  - [x] Remove/deprecate `content` field from scenario types (no longer single-file)

- [x] Task 3: Update FileSystemService for new structure (AC: 1)
  - [x] Add `ensureStepsDir(scenarioSlug: string)` method
  - [x] Add `writeStepFile(scenarioSlug: string, stepId: string, stepSlug: string, content: string)` method
  - [x] Add `readStepFile(scenarioSlug: string, stepId: string)` method
  - [x] Add `listStepFiles(scenarioSlug: string)` method
  - [x] Update path constants for new structure

- [x] Task 4: Create step file template generator (AC: 3)
  - [x] Create `generateStepMarkdown(step: Step): string` utility function
  - [x] Template must include: title header, Description, Preconditions, Actions, Expected Outcome sections
  - [x] Include Playwright code block placeholder in Actions section

- [x] Task 5: Update meta.yaml schema handling (AC: 2)
  - [x] Update `readScenarioMeta` to parse new schema with steps array
  - [x] Update `writeScenarioMeta` to include steps references
  - [x] Ensure backward compatibility check (detect v1 vs v2 scenarios)

- [x] Task 6: Write unit tests (AC: 1-5)
  - [x] Test Step type validation with zod
  - [x] Test StepReference serialization to meta.yaml
  - [x] Test step file generation matches expected format
  - [x] Test zero-padding for step IDs (01, 02, ... 10, 11)
  - [x] Test starred field in meta.yaml

## Dev Notes

### Architecture References

**Step Type Definition** [Source: architecture/4-data-models.md#4.4]
```typescript
// packages/shared/src/types/scenario.ts
export interface StepReference {
  id: string;           // Zero-padded: "01", "02", etc.
  title: string;        // Human-readable step title
  file: string;         // Filename: "01-navigate-to-login.md"
}

export interface Step {
  id: string;
  title: string;
  description: string;
  preconditions: string;
  actions: string;
  expectedOutcome: string;
}

export interface StepFile {
  id: string;
  title: string;
  content: string;  // Full markdown content
}
```

**Updated ScenarioMeta** [Source: architecture/4-data-models.md#4.5]
```typescript
export interface ScenarioMeta {
  // Scenario definition
  slug: string;
  title: string;
  starred: boolean;       // NEW
  tags: string[];
  estimatedDuration: number;
  steps: StepReference[]; // NEW

  // Statistics (machine-updated)
  totalRuns: number;
  passCount: number;
  failCount: number;
  lastRun: string | null;
  lastResult: 'pass' | 'fail' | null;
  avgDuration: number;
}
```

**Step File Format** [Source: architecture/8-database-schema.md#8.2]
```markdown
# Step 01: Navigate to Login Page

## Description
Navigate to the application's login page and verify it loads correctly.

## Preconditions
- Application is running at configured baseUrl
- User is not logged in (no session cookie)

## Actions
1. Navigate to /login
2. Wait for page to fully load

**Playwright:**
```javascript
await page.goto('/login');
await page.waitForLoadState('networkidle');
```

## Expected Outcome
- Login form is visible
- Email and password fields are present
- Submit button is enabled
- No error messages displayed
```

**Directory Structure** [Source: architecture/8-database-schema.md#8.1]
```
.harshJudge/scenarios/{slug}/
├── meta.yaml
├── steps/
│   ├── 01-{step-slug}.md
│   ├── 02-{step-slug}.md
│   └── ...
└── runs/
```

### File Locations

| Purpose | Path |
|---------|------|
| Scenario types | `packages/shared/src/types/scenario.ts` |
| FileSystemService | `packages/mcp-server/src/services/file-system-service.ts` |
| Type exports | `packages/shared/src/index.ts` |
| Unit tests | `packages/shared/tests/types/` and `packages/mcp-server/tests/services/` |

### Key Implementation Notes

1. **Zero-Padding**: Step IDs must be zero-padded to ensure correct sorting: `"01"`, `"02"`, ... `"10"`, `"11"`. Use `String(n).padStart(2, '0')`.

2. **Step Slug Generation**: Convert step title to slug for filename: `"Navigate to Login"` → `"01-navigate-to-login.md"`. Use existing `slugify` utility.

3. **Backward Compatibility**: The `readScenarioMeta` function should detect v1 scenarios (no `steps` array) and handle gracefully. This story focuses on the schema; actual migration is out of scope.

4. **Statistics Fields**: The statistics section of meta.yaml (`totalRuns`, `passCount`, etc.) remains unchanged. Only the definition section gets new fields.

5. **Error Handling**: Error handling follows existing patterns — zod validation throws on invalid input, caught by MCP error handler.

### Testing

**Test File Locations**:
- `packages/shared/tests/types/scenario.test.ts`
- `packages/mcp-server/tests/services/file-system-service.test.ts`

**Testing Framework**: Vitest with memfs [Source: architecture/15-testing-strategy.md]

**Test Patterns**:
```typescript
describe('Step types', () => {
  it('validates StepReference with zero-padded id', () => {
    const ref: StepReference = {
      id: '01',
      title: 'Navigate to login',
      file: '01-navigate-to-login.md'
    };
    expect(StepReferenceSchema.parse(ref)).toEqual(ref);
  });

  it('rejects non-zero-padded step id', () => {
    expect(() => StepReferenceSchema.parse({ id: '1', ... }))
      .toThrow('Step ID must be zero-padded');
  });
});

describe('ScenarioMeta', () => {
  it('includes starred field defaulting to false', () => {
    const meta = ScenarioMetaSchema.parse({ slug: 'test', ... });
    expect(meta.starred).toBe(false);
  });
});
```

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without issues.

### Completion Notes
- All 6 tasks completed successfully
- New types: `Step`, `StepReference`, `StepFile`, `ScenarioStats`, `Scenario` (v2), `ScenarioMeta` (v2 with Zod schema)
- Added utility functions: `padStepId()`, `generateStepFilename()`
- Legacy types preserved with @deprecated tags: `ScenarioV1`, `ScenarioFrontmatter`, `ScenarioMetaV1`
- New FileSystemService methods for step file operations: `ensureStepsDir`, `writeStepFile`, `readStepFile`, `listStepFiles`, `getStepsPath`
- `generateStepMarkdown()` function creates structured step markdown with Playwright placeholder
- Updated UX package to use `ScenarioStats` instead of full `ScenarioMeta` for backward compatibility
- 16 new shared type tests + 11 new FileSystemService tests
- All 32 shared tests pass, 25 FileSystemService tests pass
- Note: Pre-existing UX test failure in `parseEvidence.test.ts` unrelated to this story

### File List
| Action | File |
|--------|------|
| Modified | `packages/shared/src/types/scenario.ts` |
| Modified | `packages/shared/src/types/status.ts` |
| Modified | `packages/shared/src/index.ts` |
| Modified | `packages/mcp-server/src/services/file-system-service.ts` |
| Created | `packages/shared/tests/types/scenario.test.ts` |
| Modified | `packages/mcp-server/tests/services/file-system-service.test.ts` |
| Modified | `packages/ux/src/server/DashboardServer.ts` |
| Modified | `packages/ux/src/services/DataService.ts` |
| Modified | `packages/ux/src/components/detail/ScenarioStats.tsx` |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-18 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-19 | 2.0 | Implementation complete | Dev Agent (James) |
