# Story 7.1: Step-Centric Evidence View

## Status

Draft

## Story

**As a** HarshJudge user viewing test results,
**I want** evidence organized by step with tabs for different evidence types,
**so that** I can easily see all evidence for each step without hunting through different sections.

## Acceptance Criteria

1. Horizontal step navigation showing all steps (1:1 mapping with scenario steps)
   - Each step shows title
   - Click to select step
   - Steps without any evidence still appear (for completeness)
2. Selected step shows tabbed evidence sections:
   - Images tab (screenshots, before/after)
   - Logs tab (console, network logs)
   - DB Verification tab (database snapshots)
3. Each tab shows "No [type] for this step" if empty (not hidden)
4. Tabs use horizontal layout to minimize user friction
5. Remove/fix broken UI elements:
   - Remove "No runs yet" label (shows incorrectly when runs exist)
   - Remove "Never run" status from StatusBadge (confusing)
   - Remove Stats section (values not synced with runs)
   - Order runs by datetime (newest first)

## Tasks / Subtasks

- [ ] Task 1: Extend ScenarioDetail to include steps array (AC: 1)
  - [ ] Open `packages/shared/src/types/status.ts`
  - [ ] Add `steps: Array<{ id: string; title: string }>` to ScenarioDetail interface
  - [ ] Open `packages/ux/src/server/DashboardServer.ts`
  - [ ] Update `getScenarioDetail` to include steps from meta.yaml

- [ ] Task 2: Create StepSelector component (AC: 1)
  - [ ] Create `packages/ux/src/components/detail/StepSelector.tsx`
  - [ ] Accept `steps` array from scenario meta (title, id)
  - [ ] Accept `currentStepId` and `onStepSelect` props
  - [ ] Render horizontal tabs with step titles
  - [ ] Highlight selected step
  - [ ] Show all steps regardless of evidence presence
  - [ ] Add visual indicator for steps with evidence vs without

- [ ] Task 3: Create StepEvidenceView component (AC: 2, 3, 4)
  - [ ] Create `packages/ux/src/components/detail/StepEvidenceView.tsx`
  - [ ] Accept `stepId`, `runPath` props
  - [ ] Create tab state: 'images' | 'logs' | 'db'
  - [ ] Render horizontal tab bar with 3 tabs
  - [ ] Each tab shows content or "No [type] for this step" message
  - [ ] Images tab: display screenshots for current step
  - [ ] Logs tab: display console_log, network_log, html_snapshot, custom evidence
  - [ ] DB tab: display db_snapshot evidence

- [ ] Task 4: Update RunDetailPanel to use new components (AC: 1, 2)
  - [ ] Open `packages/ux/src/components/panels/RunDetailPanel.tsx`
  - [ ] Use `useScenarioDetail` hook to get steps array (Option A)
  - [ ] Replace current StepTimeline with StepSelector
  - [ ] Replace ScreenshotViewer + EvidencePanel with StepEvidenceView
  - [ ] Pass steps from scenarioDetail to StepSelector
  - [ ] Pass current stepId and runPath to StepEvidenceView

- [ ] Task 5: Create useStepEvidence hook (AC: 2)
  - [ ] Create `packages/ux/src/hooks/useStepEvidence.ts`
  - [ ] Accept `runPath` and `stepId` parameters
  - [ ] Fetch evidence from `step-{id}/evidence/` directory
  - [ ] Categorize evidence by type (screenshots, logs, db)
  - [ ] Return `{ images, logs, dbSnapshots, loading, error }`

- [ ] Task 6: Update DataService for step evidence (AC: 2)
  - [ ] Open `packages/ux/src/server/DataService.ts`
  - [ ] Add `getStepEvidence(runPath: string, stepId: string)` method
  - [ ] Read from `{runPath}/step-{stepId}/evidence/` directory
  - [ ] Parse and categorize evidence by type
  - [ ] Return typed evidence arrays

- [ ] Task 7: Remove "No runs yet" label (AC: 5)
  - [ ] Open `packages/ux/src/components/detail/RunHistoryList.tsx`
  - [ ] Remove or fix the empty state message at line 21-25
  - [ ] If runs array is empty, show nothing or minimal message

- [ ] Task 8: Remove "Never run" status (AC: 5)
  - [ ] Open `packages/ux/src/components/common/StatusBadge.tsx`
  - [ ] Remove 'never_run' from StatusType
  - [ ] Remove 'never_run' entry from STATUS_COLORS and STATUS_LABELS
  - [ ] Open `packages/ux/src/components/panels/ScenarioListPanel.tsx`
  - [ ] Update status logic that uses 'never_run'
  - [ ] Open `packages/shared/src/types/status.ts`
  - [ ] Remove `neverRun: number` from ProjectStatus interface
  - [ ] Open `packages/ux/src/server/DashboardServer.ts`
  - [ ] Remove neverRun calculation from getProjectStatus
  - [ ] Update `packages/ux/src/services/DataService.ts` if applicable
  - [ ] Update related tests:
    - [ ] `packages/ux/tests/components/StatusBadge.test.tsx`
    - [ ] `packages/ux/tests/components/ProjectListPanel.test.tsx`
    - [ ] `packages/ux/tests/services/DataService.test.ts`

- [ ] Task 9: Remove Stats section (AC: 5)
  - [ ] Open `packages/ux/src/components/panels/ScenarioDetailPanel.tsx`
  - [ ] Remove the Statistics section (lines 95-99)
  - [ ] Remove import of ScenarioStats component
  - [ ] Delete `packages/ux/src/components/detail/ScenarioStats.tsx`
  - [ ] Delete `packages/ux/tests/components/detail/ScenarioStats.test.tsx`
  - [ ] Update `packages/ux/src/components/detail/index.ts` to remove ScenarioStats export

- [ ] Task 10: Order runs by datetime newest first (AC: 5)
  - [ ] Open `packages/ux/src/server/DashboardServer.ts` or DataService
  - [ ] Ensure runs are sorted by `startedAt` or `completedAt` descending
  - [ ] Verify RunHistoryList displays in correct order

- [ ] Task 11: Write component tests (AC: 1-5)
  - [ ] Test StepSelector renders all steps
  - [ ] Test StepSelector highlights selected step
  - [ ] Test StepEvidenceView shows correct tabs
  - [ ] Test StepEvidenceView shows "No [type]" for empty tabs
  - [ ] Test StatusBadge without never_run status

## Dev Notes

### Architecture References

**Component Organization** [Source: architecture/9-frontend-architecture.md#9.1]
```
packages/ux/src/components/
├── detail/
│   ├── StepSelector.tsx      # NEW: horizontal step tabs
│   ├── StepEvidenceView.tsx  # NEW: tabbed evidence viewer
│   ├── StepTimeline.tsx      # EXISTING: may be replaced or modified
│   └── EvidencePanel.tsx     # EXISTING: may be replaced
```

**Current RunDetailPanel Structure** [Source: packages/ux/src/components/panels/RunDetailPanel.tsx]
- Uses `parseEvidencePaths()` to get steps FROM evidence (wrong - should come from meta)
- StepTimeline only shows steps that HAVE screenshots
- EvidencePanel shows non-screenshot evidence separately

**Evidence Directory Structure** [Source: architecture/8-database-schema.md]
```
.harshJudge/scenarios/{slug}/runs/{runId}/
├── result.json
└── step-01/
    └── evidence/
        ├── screenshot.png
        ├── console.log
        └── db-snapshot.json
```

**Component Template** [Source: architecture/9-frontend-architecture.md#9.1]
```typescript
import { type FC } from 'react';

interface StepSelectorProps {
  steps: Array<{ id: string; title: string }>;
  currentStepId: string | null;
  onStepSelect: (stepId: string) => void;
  stepsWithEvidence?: Set<string>; // Optional: to show indicator
}

export const StepSelector: FC<StepSelectorProps> = ({
  steps,
  currentStepId,
  onStepSelect,
  stepsWithEvidence,
}) => {
  return (
    <div className="flex gap-2 overflow-x-auto p-2 border-b border-gray-700">
      {steps.map((step) => (
        <button
          key={step.id}
          onClick={() => onStepSelect(step.id)}
          className={`
            px-3 py-2 rounded text-sm whitespace-nowrap
            ${currentStepId === step.id ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}
          `}
        >
          {step.id}: {step.title}
        </button>
      ))}
    </div>
  );
};
```

**Tab Component Pattern**
```typescript
type EvidenceTab = 'images' | 'logs' | 'db';

const TAB_LABELS: Record<EvidenceTab, string> = {
  images: 'Images',
  logs: 'Logs',
  db: 'DB Verification',
};

const [activeTab, setActiveTab] = useState<EvidenceTab>('images');
```

### Data Access Strategy (Option A - Recommended)

**Extend ScenarioDetail to include steps:**

The `ScenarioDetail` interface currently has `stepCount` but not the actual steps array. We need to:

1. Add `steps: Array<{ id: string; title: string }>` to `ScenarioDetail` in `packages/shared/src/types/status.ts`
2. Update `DashboardServer.getScenarioDetail()` to include steps from meta.yaml
3. In `RunDetailPanel`, use `useScenarioDetail` hook to get steps

This keeps the data flow clean - scenario detail includes step information for the UI to use.

```typescript
// packages/shared/src/types/status.ts
export interface ScenarioDetail {
  slug: string;
  title: string;
  starred: boolean;
  tags: string[];
  stepCount: number;
  steps: Array<{ id: string; title: string }>; // ADD THIS
  content: string;
  meta: ScenarioStats;
  recentRuns: RunSummary[];
}
```

### Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `shared/types/status.ts` | MODIFY | Add steps to ScenarioDetail, remove neverRun from ProjectStatus |
| `components/detail/StepSelector.tsx` | CREATE | Horizontal step navigation |
| `components/detail/StepEvidenceView.tsx` | CREATE | Tabbed evidence viewer |
| `components/panels/RunDetailPanel.tsx` | MODIFY | Use new components |
| `hooks/useStepEvidence.ts` | CREATE | Fetch per-step evidence |
| `server/DashboardServer.ts` | MODIFY | Include steps in scenario detail, remove neverRun |
| `server/DataService.ts` | MODIFY | Add getStepEvidence method |
| `components/detail/RunHistoryList.tsx` | MODIFY | Remove "No runs yet" |
| `components/common/StatusBadge.tsx` | MODIFY | Remove never_run |
| `components/panels/ScenarioListPanel.tsx` | MODIFY | Update never_run usage |
| `components/panels/ScenarioDetailPanel.tsx` | MODIFY | Remove Stats section |
| `components/detail/ScenarioStats.tsx` | DELETE | No longer needed |
| `components/detail/index.ts` | MODIFY | Remove ScenarioStats export |
| `tests/components/detail/ScenarioStats.test.tsx` | DELETE | No longer needed |
| `tests/components/StatusBadge.test.tsx` | MODIFY | Remove never_run tests |
| `tests/components/ProjectListPanel.test.tsx` | MODIFY | Update if uses never_run |
| `tests/services/DataService.test.ts` | MODIFY | Update if uses never_run |

### Key Implementation Notes

1. **Step Source:** Steps must come from scenario `meta.yaml`, NOT from evidence paths. This ensures all steps are shown even if they have no evidence.

2. **Step ID Format:** Steps use zero-padded IDs: "01", "02", etc.

3. **Evidence Types:**
   - `screenshot` → Images tab
   - `console_log`, `network_log` → Logs tab
   - `html_snapshot` → Logs tab (treat as diagnostic artifact)
   - `custom` → Logs tab (fallback for unknown types)
   - `db_snapshot` → DB Verification tab

4. **Empty State Messages:**
   - "No screenshots for this step"
   - "No logs captured for this step"
   - "No database snapshots for this step"

5. **Run Ordering:** Runs should be sorted by `startedAt` descending (newest first).

6. **never_run Removal Scope:** This status is used in 9 files - ensure all are updated:
   - StatusBadge.tsx (type definition)
   - ScenarioListPanel.tsx (status display)
   - DataService.ts (calculation)
   - DashboardServer.ts (calculation)
   - ApiDataService.ts (if applicable)
   - ProjectStatus type (neverRun field)
   - Related test files (3 files)

### Testing

**Test File Location:** `packages/ux/tests/components/`

**Testing Framework:** Vitest with React Testing Library [Source: architecture/15-testing-strategy.md]

**Test Patterns:**
```typescript
describe('StepSelector', () => {
  const mockSteps = [
    { id: '01', title: 'Navigate to login' },
    { id: '02', title: 'Enter credentials' },
    { id: '03', title: 'Submit form' },
  ];

  it('renders all steps', () => {
    render(<StepSelector steps={mockSteps} currentStepId={null} onStepSelect={() => {}} />);
    expect(screen.getByText('01: Navigate to login')).toBeInTheDocument();
    expect(screen.getByText('02: Enter credentials')).toBeInTheDocument();
    expect(screen.getByText('03: Submit form')).toBeInTheDocument();
  });

  it('highlights selected step', () => {
    render(<StepSelector steps={mockSteps} currentStepId="02" onStepSelect={() => {}} />);
    const selectedButton = screen.getByText('02: Enter credentials');
    expect(selectedButton).toHaveClass('bg-blue-600');
  });
});

describe('StepEvidenceView', () => {
  it('shows "No screenshots" when images tab is empty', () => {
    render(<StepEvidenceView stepId="01" runPath="/path" evidence={{ images: [], logs: [], db: [] }} />);
    expect(screen.getByText('No screenshots for this step')).toBeInTheDocument();
  });

  it('switches between tabs', async () => {
    render(<StepEvidenceView ... />);
    fireEvent.click(screen.getByText('Logs'));
    expect(screen.getByText('No logs captured for this step')).toBeInTheDocument();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-24 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-24 | 1.1 | QA Review: Added Task 1 for ScenarioDetail steps, expanded Task 8 for all never_run usages, expanded Task 9 for test cleanup, clarified evidence type mapping | QA Review |
