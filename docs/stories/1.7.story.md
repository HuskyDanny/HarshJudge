# Story 1.7: Implement `recordEvidence` MCP Tool

## Status

Done

## Story

**As a** Claude Code user,
**I want** to record test evidence artifacts,
**so that** screenshots, logs, and data are captured with each test step.

## Acceptance Criteria

1. `recordEvidence` tool registered in MCP server with proper schema
2. Tool accepts parameters: `runId`, `step`, `type`, `name`, `data`, `metadata` (optional)
3. Tool validates run exists and is not completed
4. Tool validates evidence type: `screenshot`, `db_snapshot`, `console_log`, `network_log`, `html_snapshot`, `custom`
5. Tool decodes base64 data for binary types (screenshots)
6. Tool writes evidence to `evidence/step-{nn}-{name}.{ext}`
7. Tool writes metadata to `evidence/step-{nn}-{name}.meta.json`
8. Tool returns success status, file path, file size
9. Unit tests verify file writing and validation

## Tasks / Subtasks

- [x] **Task 1: Implement recordEvidence handler**
- [x] **Task 2: Update mcp-server exports**
- [x] **Task 3: Write unit tests**
- [x] **Task 4: Verify build and tests pass**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story | SM Agent (Bob) |

---

## Dev Agent Record

**Implementation Date:** 2025-12-04

**Files Created/Modified:**
- `packages/mcp-server/src/handlers/record-evidence.ts` (NEW) - Handler implementation
- `packages/mcp-server/tests/handlers/record-evidence.test.ts` (NEW) - 17 unit tests
- `packages/shared/src/schemas/mcp-schemas.ts` (MODIFIED) - Added RecordEvidenceParamsSchema
- `packages/shared/src/types/mcp-types.ts` (MODIFIED) - Added RecordEvidenceResult type

**Implementation Details:**
- Validates run exists and is not completed by checking for `result.json`
- Supports 6 evidence types: screenshot, db_snapshot, console_log, network_log, html_snapshot, custom
- Decodes base64 data for binary types (screenshot, html_snapshot)
- Writes evidence to `evidence/step-{nn}-{name}.{ext}` with proper file extensions
- Writes metadata JSON file alongside each evidence file
- Returns success status, file path, metadata path, and file size

**Test Coverage:** 17 tests covering all evidence types, validation errors, and edge cases

---

## QA Results

**QA Date:** 2025-12-04
**Status:** PASSED

- All 17 unit tests pass
- TypeScript compilation successful
- ESLint validation passed
- All acceptance criteria met
