# Story 6.4: createScenario MCP Tool

## Status

Done

## Story

**As a** HarshJudge user,
**I want** an MCP tool that creates scenario structure from conversation context,
**so that** scenario setup is automated and consistent.

## Acceptance Criteria

1. New MCP tool `createScenario` with schema:
   ```typescript
   {
     slug: string,
     title: string,
     steps: Array<{
       title: string,
       description: string,
       actions: string,
       expectedOutcome: string
     }>,
     tags?: string[],
     estimatedDuration?: number
   }
   ```
2. Tool creates full scenario structure:
   - `meta.yaml` with ordered step references
   - Individual step `.md` files in `steps/` folder
3. Tool reads `.harshJudge/prd.md` for project context (if exists)
4. Returns created file paths for confirmation
5. `saveScenario` tool deprecated/removed (replaced by `createScenario`)

## Tasks / Subtasks

- [ ] Task 1: Define CreateScenarioParams schema (AC: 1)
  - [ ] Open `packages/shared/src/types/mcp-tools.ts`
  - [ ] Add `StepInput` zod schema (title, description, preconditions, actions, expectedOutcome)
  - [ ] Add `CreateScenarioParams` zod schema with steps array
  - [ ] Add `starred: z.boolean().optional().default(false)` field
  - [ ] Add `CreateScenarioResult` interface with file paths

- [ ] Task 2: Create createScenario handler (AC: 2, 4)
  - [ ] Create `packages/mcp-server/src/handlers/create-scenario.ts`
  - [ ] Validate input with CreateScenarioParams schema
  - [ ] Create scenario directory structure
  - [ ] Generate step files using step template (from Story 6.2)
  - [ ] Generate meta.yaml with step references
  - [ ] Return paths to all created files

- [ ] Task 3: Implement step file generation (AC: 2)
  - [ ] Create `generateStepFile(stepId: string, step: StepInput): string` function
  - [ ] Use zero-padded step ID for filename
  - [ ] Generate markdown with: title, description, preconditions, actions, expected outcome
  - [ ] Include Playwright code block placeholder

- [ ] Task 4: Implement meta.yaml generation (AC: 2)
  - [ ] Create `generateMetaYaml(params: CreateScenarioParams, stepFiles: string[]): object`
  - [ ] Include scenario definition fields (title, slug, starred, tags, estimatedDuration)
  - [ ] Include steps array with id, title, file references
  - [ ] Initialize statistics fields (totalRuns: 0, passCount: 0, etc.)

- [ ] Task 5: Read project PRD context (AC: 3)
  - [ ] Check if `.harshJudge/prd.md` exists
  - [ ] If exists, read and include relevant context in step files (optional)
  - [ ] Log warning if PRD not found (non-blocking)

- [ ] Task 6: Deprecate saveScenario handler (AC: 5)
  - [ ] Add `@deprecated` JSDoc comment to `save-scenario.ts`
  - [ ] Add console warning when saveScenario is called
  - [ ] Keep handler functional for backward compatibility
  - [ ] Update tool description in server.ts to mention deprecation

- [ ] Task 7: Register createScenario in MCP server (AC: 1)
  - [ ] Open `packages/mcp-server/src/server.ts`
  - [ ] Import `handleCreateScenario` handler
  - [ ] Add `createScenario` to tools/list response
  - [ ] Add case in tools/call switch statement

- [ ] Task 8: Add toggleStar handler (AC: 1 - from architecture)
  - [ ] Create `packages/mcp-server/src/handlers/toggle-star.ts`
  - [ ] Read meta.yaml, toggle/set starred field, write back
  - [ ] Register in server.ts

- [ ] Task 9: Write unit tests (AC: 1-5)
  - [ ] Test createScenario creates directory structure
  - [ ] Test step files have correct content
  - [ ] Test meta.yaml has correct step references
  - [ ] Test scenario without PRD still works
  - [ ] Test saveScenario shows deprecation warning

## Dev Notes

### Architecture References

**CreateScenarioParams Schema** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export const StepInput = z.object({
  title: z.string().min(1),
  description: z.string().optional().default(''),
  preconditions: z.string().optional().default(''),
  actions: z.string().min(1),
  expectedOutcome: z.string().min(1),
});

export const CreateScenarioParams = z.object({
  slug: z.string().regex(/^[a-z0-9-]+$/, 'Slug must be lowercase alphanumeric with hyphens'),
  title: z.string().min(1).max(200),
  steps: z.array(StepInput).min(1),
  tags: z.array(z.string()).optional().default([]),
  estimatedDuration: z.number().positive().optional().default(60),
  starred: z.boolean().optional().default(false),
});
```

**CreateScenarioResult** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export interface CreateScenarioResult {
  success: boolean;
  slug: string;
  scenarioPath: string;
  metaPath: string;
  stepsPath: string;
  stepFiles: string[];
  isNew: boolean;
}
```

**ToggleStar Tool** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export const ToggleStarParams = z.object({
  scenarioSlug: z.string().regex(/^[a-z0-9-]+$/),
  starred: z.boolean().optional(), // If omitted, toggles current state
});

export interface ToggleStarResult {
  success: boolean;
  slug: string;
  starred: boolean;
}
```

**Step File Format** [Source: architecture/8-database-schema.md#8.2]
```markdown
# Step 01: Navigate to Login Page

## Description
Navigate to the application's login page and verify it loads correctly.

## Preconditions
- Application is running at configured baseUrl
- User is not logged in (no session cookie)

## Actions
1. Navigate to /login
2. Wait for page to fully load

**Playwright:**
```javascript
await page.goto('/login');
await page.waitForLoadState('networkidle');
```

## Expected Outcome
- Login form is visible
- Email and password fields are present
- Submit button is enabled
- No error messages displayed
```

### File Locations

| Purpose | Path |
|---------|------|
| MCP tool schemas | `packages/shared/src/types/mcp-tools.ts` |
| createScenario handler (NEW) | `packages/mcp-server/src/handlers/create-scenario.ts` |
| toggleStar handler (NEW) | `packages/mcp-server/src/handlers/toggle-star.ts` |
| saveScenario handler (deprecated) | `packages/mcp-server/src/handlers/save-scenario.ts` |
| Server registration | `packages/mcp-server/src/server.ts` |
| Slugify utility | `packages/mcp-server/src/utils/slugify.ts` |

### Key Implementation Notes

1. **Step ID Generation**: Steps are numbered sequentially starting from 01. Use `String(index + 1).padStart(2, '0')` to generate IDs.

2. **Step Slug Generation**: Convert step title to slug for filename:
   ```typescript
   const stepSlug = slugify(step.title);
   const filename = `${stepId}-${stepSlug}.md`;
   // Example: "01-navigate-to-login.md"
   ```

3. **Overwrite Behavior**: If scenario already exists:
   - Update meta.yaml with new definition
   - Overwrite existing step files
   - Remove orphaned step files (files not in new steps array)
   - Set `isNew: false` in result

4. **PRD Context**: Reading PRD is optional enhancement. Core functionality works without it. If PRD exists, extract relevant tech stack info for step templates.

5. **Deprecation Pattern**:
   ```typescript
   /** @deprecated Use createScenario instead */
   export async function handleSaveScenario(params: unknown): Promise<SaveScenarioResult> {
     console.warn('[HarshJudge] saveScenario is deprecated. Use createScenario instead.');
     // ... existing implementation
   }
   ```

6. **Error Handling**: Follow existing MCP error handler pattern. Invalid params throw validation error with helpful message.

### Testing

**Test File Location**: `packages/mcp-server/tests/handlers/create-scenario.test.ts`

**Testing Framework**: Vitest with memfs [Source: architecture/15-testing-strategy.md]

**Test Patterns**:
```typescript
describe('createScenario handler', () => {
  beforeEach(() => {
    vol.reset();
    // Initialize .harshJudge directory
    vol.mkdirSync('.harshJudge/scenarios', { recursive: true });
  });

  it('creates scenario directory structure', async () => {
    const result = await handleCreateScenario({
      slug: 'login-flow',
      title: 'User Login Flow',
      steps: [
        { title: 'Navigate to login', actions: 'Go to /login', expectedOutcome: 'Form visible' },
        { title: 'Enter credentials', actions: 'Fill form', expectedOutcome: 'Fields populated' }
      ]
    });

    expect(result.success).toBe(true);
    expect(vol.existsSync('.harshJudge/scenarios/login-flow/meta.yaml')).toBe(true);
    expect(vol.existsSync('.harshJudge/scenarios/login-flow/steps/01-navigate-to-login.md')).toBe(true);
    expect(vol.existsSync('.harshJudge/scenarios/login-flow/steps/02-enter-credentials.md')).toBe(true);
  });

  it('returns all created file paths', async () => {
    const result = await handleCreateScenario({ ... });

    expect(result.stepFiles).toHaveLength(2);
    expect(result.stepFiles[0]).toContain('01-');
    expect(result.stepFiles[1]).toContain('02-');
  });

  it('generates correct meta.yaml', async () => {
    await handleCreateScenario({ slug: 'test', title: 'Test', steps: [...], starred: true });

    const meta = yaml.load(vol.readFileSync('.harshJudge/scenarios/test/meta.yaml', 'utf-8'));
    expect(meta.starred).toBe(true);
    expect(meta.steps).toHaveLength(2);
    expect(meta.steps[0].id).toBe('01');
  });
});

describe('toggleStar handler', () => {
  it('toggles starred status', async () => {
    // Setup: create scenario with starred: false
    const result = await handleToggleStar({ scenarioSlug: 'test' });
    expect(result.starred).toBe(true);

    const result2 = await handleToggleStar({ scenarioSlug: 'test' });
    expect(result2.starred).toBe(false);
  });

  it('sets explicit starred value', async () => {
    const result = await handleToggleStar({ scenarioSlug: 'test', starred: true });
    expect(result.starred).toBe(true);
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-18 | 1.0 | Initial story draft | SM Agent (Bob) |
