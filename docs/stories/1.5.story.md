# Story 1.5: Implement `saveScenario` MCP Tool

## Status

Done

## Story

**As a** Claude Code user,
**I want** to save test scenarios to the filesystem,
**so that** my scenario definitions are persisted and organized.

## Acceptance Criteria

1. `saveScenario` tool registered in MCP server with proper schema
2. Tool accepts parameters: `slug`, `title`, `content`, `tags` (optional), `estimatedDuration` (optional)
3. Tool validates slug is URL-safe (lowercase, hyphens, no special chars)
4. Tool creates scenario directory: `.harshJudge/scenarios/{slug}/`
5. Tool writes `scenario.md` with provided content and YAML frontmatter
6. Tool generates `meta.yaml` with initial statistics (0 runs, no last result)
7. Tool handles duplicate slugs by appending numeric suffix
8. Tool returns created paths and metadata
9. Unit tests verify file creation and validation logic

## Tasks / Subtasks

- [x] **Task 1: Implement saveScenario handler** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] Create `packages/mcp-server/src/handlers/save-scenario.ts`
  - [x] Import `SaveScenarioParamsSchema` from `@harshjudge/shared`
  - [x] Validate input parameters using Zod schema
  - [x] Check if project is initialized (`.harshJudge/` exists)
  - [x] Handle duplicate slugs by finding unique slug with suffix
  - [x] Create scenario directory: `.harshJudge/scenarios/{slug}/`
  - [x] Write `scenario.md` with YAML frontmatter + content
  - [x] Write `meta.yaml` with initial statistics
  - [x] Return `SaveScenarioResult` with paths and isNew flag

- [x] **Task 2: Create slug utility for duplicate handling** (AC: 7)
  - [x] Implemented `findUniqueSlug` as inline function in handler
  - [x] Logic: if slug exists, try slug-2, slug-3, etc. (up to 1000)

- [x] **Task 3: Update mcp-server exports** (AC: 1)
  - [x] Export `handleSaveScenario` from `index.ts`

- [x] **Task 4: Write unit tests for saveScenario handler** (AC: 9)
  - [x] Create `packages/mcp-server/tests/handlers/save-scenario.test.ts`
  - [x] Test successful scenario creation with all fields
  - [x] Test scenario creation with minimal fields (only required)
  - [x] Test error when project not initialized
  - [x] Test validation errors for invalid slug format
  - [x] Test validation errors for empty title/content
  - [x] Test duplicate slug handling (appends suffix)
  - [x] Test scenario.md contains correct frontmatter
  - [x] Test meta.yaml has correct initial values

- [x] **Task 5: Verify build and tests pass** (AC: 1-9)
  - [x] Run `pnpm build` to verify compilation
  - [x] Run `pnpm test` to verify all tests pass
  - [x] Run `pnpm typecheck` to verify types
  - [x] Run `pnpm lint` to verify code quality

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.4.story.md#Dev Agent Record]

From Story 1.4 implementation:
- `FileSystemService` is available with all needed methods:
  - `ensureDir()`, `exists()`, `writeFile()`, `readFile()`
  - `writeYaml()`, `readYaml()`, `writeJson()`, `readJson()`
  - `listDirs()` for directory listing
- Handler pattern established with dependency injection for `FileSystemService`
- All handlers use Zod validation from `@harshjudge/shared`
- Tests use memfs for filesystem mocking

### Handler Implementation Pattern
[Source: architecture/10-backend-architecture-mcp-server.md]

```typescript
// packages/mcp-server/src/handlers/save-scenario.ts
import {
  SaveScenarioParamsSchema,
  type SaveScenarioResult,
  type ScenarioMeta,
} from '@harshjudge/shared';
import { FileSystemService } from '../services/file-system-service.js';

const HARSH_JUDGE_DIR = '.harshJudge';
const SCENARIOS_DIR = 'scenarios';
const SCENARIO_FILE = 'scenario.md';
const META_FILE = 'meta.yaml';

/**
 * Finds a unique slug by appending numeric suffix if needed.
 */
async function findUniqueSlug(
  fs: FileSystemService,
  baseSlug: string
): Promise<{ slug: string; isNew: boolean }> {
  const scenarioPath = `${HARSH_JUDGE_DIR}/${SCENARIOS_DIR}/${baseSlug}`;

  if (!(await fs.exists(scenarioPath))) {
    return { slug: baseSlug, isNew: true };
  }

  // Find unique slug with suffix
  let suffix = 2;
  while (true) {
    const newSlug = `${baseSlug}-${suffix}`;
    const newPath = `${HARSH_JUDGE_DIR}/${SCENARIOS_DIR}/${newSlug}`;
    if (!(await fs.exists(newPath))) {
      return { slug: newSlug, isNew: true };
    }
    suffix++;
  }
}

/**
 * Saves a test scenario to the filesystem.
 */
export async function handleSaveScenario(
  params: unknown,
  fs: FileSystemService = new FileSystemService()
): Promise<SaveScenarioResult> {
  // 1. Validate input parameters
  const validated = SaveScenarioParamsSchema.parse(params);

  // 2. Check if project is initialized
  if (!(await fs.exists(HARSH_JUDGE_DIR))) {
    throw new Error(
      'Project not initialized. Run initProject first.'
    );
  }

  // 3. Find unique slug
  const { slug, isNew } = await findUniqueSlug(fs, validated.slug);

  // 4. Create scenario directory
  const scenarioDir = `${HARSH_JUDGE_DIR}/${SCENARIOS_DIR}/${slug}`;
  await fs.ensureDir(scenarioDir);

  // 5. Write scenario.md with YAML frontmatter
  const frontmatter = `---
id: ${slug}
title: ${validated.title}
tags: [${validated.tags.join(', ')}]
estimatedDuration: ${validated.estimatedDuration}
---

`;
  const scenarioContent = frontmatter + validated.content;
  const scenarioPath = `${scenarioDir}/${SCENARIO_FILE}`;
  await fs.writeFile(scenarioPath, scenarioContent);

  // 6. Write meta.yaml with initial statistics
  const initialMeta: ScenarioMeta = {
    totalRuns: 0,
    passCount: 0,
    failCount: 0,
    lastRun: null,
    lastResult: null,
    avgDuration: 0,
  };
  const metaPath = `${scenarioDir}/${META_FILE}`;
  await fs.writeYaml(metaPath, initialMeta);

  // 7. Return result
  return {
    success: true,
    slug,
    scenarioPath,
    metaPath,
    isNew,
  };
}
```

### Directory Structure After saveScenario
[Source: architecture/8-database-schema.md#81-directory-structure-schema]

```
.harshJudge/
├── config.yaml
├── .gitignore
└── scenarios/
    └── {slug}/                    # Created by saveScenario
        ├── scenario.md            # YAML frontmatter + content
        └── meta.yaml              # Initial statistics
```

### scenario.md Format
[Source: architecture/8-database-schema.md#scenariomd]

```markdown
---
id: login-flow
title: User Login Flow
tags: [auth, critical]
estimatedDuration: 30
---

# Overview
Test the complete user login flow.

# Steps
...
```

### meta.yaml Initial Values
[Source: architecture/8-database-schema.md#metayaml]

```yaml
totalRuns: 0
passCount: 0
failCount: 0
lastRun: null
lastResult: null
avgDuration: 0
```

### File Locations
[Source: architecture/11-unified-project-structure.md]

**Files to create:**
```
packages/mcp-server/
├── src/
│   ├── handlers/
│   │   └── save-scenario.ts          # Handler implementation
│   └── utils/
│       └── slug.ts                   # Slug utility (optional, can be inline)
└── tests/
    └── handlers/
        └── save-scenario.test.ts     # Handler tests
```

### Shared Types Available
[Source: packages/shared/src/types/mcp-tools.ts]

```typescript
// Already defined in @harshjudge/shared
export const SaveScenarioParamsSchema = z.object({
  slug: z.string().regex(/^[a-z0-9-]+$/, 'Slug must be lowercase alphanumeric with hyphens'),
  title: z.string().min(1).max(200),
  content: z.string().min(1),
  tags: z.array(z.string()).optional().default([]),
  estimatedDuration: z.number().positive().optional().default(60),
});

export interface SaveScenarioResult {
  success: boolean;
  slug: string;
  scenarioPath: string;
  metaPath: string;
  isNew: boolean;
}

// Also available:
export interface ScenarioMeta {
  totalRuns: number;
  passCount: number;
  failCount: number;
  lastRun: string | null;
  lastResult: 'pass' | 'fail' | null;
  avgDuration: number;
}
```

### Testing Strategy
[Source: architecture/15-testing-strategy.md]

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { vol } from 'memfs';
import { handleSaveScenario } from '../../src/handlers/save-scenario.js';
import { FileSystemService } from '../../src/services/file-system-service.js';

vi.mock('fs/promises', async () => {
  const memfs = await import('memfs');
  return memfs.fs.promises;
});

describe('handleSaveScenario', () => {
  let fs: FileSystemService;

  beforeEach(() => {
    vol.reset();
    vol.mkdirSync('/project/.harshJudge/scenarios', { recursive: true });
    fs = new FileSystemService('/project');
  });

  it('creates scenario directory and files', async () => {
    const result = await handleSaveScenario({
      slug: 'login-test',
      title: 'Login Test',
      content: '# Steps\n1. Go to login page',
    }, fs);

    expect(result.success).toBe(true);
    expect(result.slug).toBe('login-test');
    expect(vol.existsSync('/project/.harshJudge/scenarios/login-test')).toBe(true);
    expect(vol.existsSync('/project/.harshJudge/scenarios/login-test/scenario.md')).toBe(true);
    expect(vol.existsSync('/project/.harshJudge/scenarios/login-test/meta.yaml')).toBe(true);
  });

  it('handles duplicate slugs by appending suffix', async () => {
    vol.mkdirSync('/project/.harshJudge/scenarios/my-test', { recursive: true });

    const result = await handleSaveScenario({
      slug: 'my-test',
      title: 'My Test',
      content: '# Content',
    }, fs);

    expect(result.slug).toBe('my-test-2');
    expect(result.isNew).toBe(true);
  });

  it('throws error if project not initialized', async () => {
    vol.reset();
    vol.mkdirSync('/project', { recursive: true });
    const freshFs = new FileSystemService('/project');

    await expect(
      handleSaveScenario({ slug: 'test', title: 'Test', content: 'Content' }, freshFs)
    ).rejects.toThrow('not initialized');
  });
});
```

### Coding Standards
[Source: architecture/16-coding-standards.md]

- **File Operations:** All file operations go through `FileSystemService`
- **Path Safety:** Always use string concatenation with `/`, FileSystemService handles path joining
- **Error Handling:** All handlers must catch errors and return structured error responses
- **Validation:** All MCP tool inputs must be validated with Zod before processing
- **File Names:** kebab-case (`save-scenario.ts`, `save-scenario.test.ts`)

### Validation Commands
```bash
pnpm install          # If new dependencies needed
pnpm build            # Verify compilation
pnpm test             # Verify all tests pass
pnpm typecheck        # Verify type checking
pnpm lint             # Verify linting
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Implemented `handleSaveScenario` handler following the established pattern
- Uses `SaveScenarioParamsSchema` from `@harshjudge/shared` for validation
- Implements duplicate slug handling with numeric suffix (slug-2, slug-3, etc.)
- Creates scenario directory with `scenario.md` (YAML frontmatter + content)
- Creates `meta.yaml` with initial statistics (all zeros, nulls)
- Added safety limit of 1000 attempts for unique slug finding
- Handler accepts optional `FileSystemService` for dependency injection in tests
- Created comprehensive unit tests (23 tests for saveScenario handler)
- All validation commands passed:
  - `pnpm build` - 3 packages built successfully
  - `pnpm test` - 68 tests passing (16 shared + 51 mcp-server + 1 ux)
  - `pnpm typecheck` - No type errors
  - `pnpm lint` - No linting errors

### File List

**New Files:**
- `packages/mcp-server/src/handlers/save-scenario.ts` - saveScenario handler
- `packages/mcp-server/tests/handlers/save-scenario.test.ts` - Handler tests (23 tests)

**Modified Files:**
- `packages/mcp-server/src/index.ts` - Added export for handleSaveScenario

---

## QA Results

### QA Agent: Quinn
### Date: 2025-12-04
### Verdict: ✅ PASS

### Acceptance Criteria Verification

| AC | Criteria | Status | Notes |
|----|----------|--------|-------|
| 1 | `saveScenario` tool registered in MCP server with proper schema | ✅ | Handler exported from `index.ts` |
| 2 | Tool accepts parameters: `slug`, `title`, `content`, `tags` (optional), `estimatedDuration` (optional) | ✅ | Uses `SaveScenarioParamsSchema` |
| 3 | Tool validates slug is URL-safe (lowercase, hyphens, no special chars) | ✅ | Regex `/^[a-z0-9-]+$/` in schema |
| 4 | Tool creates scenario directory: `.harshJudge/scenarios/{slug}/` | ✅ | Verified in tests |
| 5 | Tool writes `scenario.md` with provided content and YAML frontmatter | ✅ | Frontmatter contains id, title, tags, estimatedDuration |
| 6 | Tool generates `meta.yaml` with initial statistics (0 runs, no last result) | ✅ | Initial values all zeros/nulls |
| 7 | Tool handles duplicate slugs by appending numeric suffix | ✅ | Implemented with safety limit of 1000 |
| 8 | Tool returns created paths and metadata | ✅ | Returns `SaveScenarioResult` |
| 9 | Unit tests verify file creation and validation logic | ✅ | 23 tests covering all scenarios |

### Validation Commands

```
pnpm build     ✅ PASS
pnpm test      ✅ 68 tests passing (16 shared + 51 mcp-server + 1 ux)
pnpm typecheck ✅ PASS
pnpm lint      ✅ PASS
```

### Code Quality Assessment

- ✅ **SOLID**: Dependency injection for FileSystemService enables isolated testing
- ✅ **KISS**: Simple, clear implementation with straightforward flow
- ✅ **DRY**: Reuses `FileSystemService` from Story 1.4
- ✅ **Error Handling**: Checks project initialization, validates with Zod
- ✅ **Constants**: File/directory names extracted as constants
- ✅ **Safety**: Added 1000 iteration limit for unique slug finding to prevent infinite loops

### Test Coverage

- saveScenario handler: 23 tests covering:
  - Successful scenario creation (5 tests)
  - Duplicate slug handling (3 tests)
  - Error handling (10 tests)
  - Edge cases (5 tests)

### Notes

Implementation follows the established patterns from Story 1.4. The duplicate slug handling with safety limit is a nice defensive programming practice.
