# Story 1.2: Configure Build and Development Tooling

## Status

Done

## Story

**As a** developer,
**I want** consistent build scripts and development workflows,
**so that** I can efficiently build, test, and develop across all packages.

## Acceptance Criteria

1. Root-level scripts: `build`, `dev`, `test`, `lint`, `clean` that operate across all packages
2. Each package has individual `build`, `dev`, `test` scripts
3. `packages/shared` builds first (dependency for other packages)
4. TypeScript compilation outputs to `dist/` in each package
5. Source maps generated for debugging
6. Vitest configured at root with workspace support for all packages
7. Build completes without errors for empty/skeleton packages

## Tasks / Subtasks

- [x] **Task 1: Verify and update root-level scripts** (AC: 1)
  - [x] Verify `build`, `dev`, `test`, `lint`, `clean` scripts exist in root `package.json`
  - [x] Add `test:watch` script for watch mode testing: `"test:watch": "turbo run test -- --watch"`
  - [x] Ensure scripts properly delegate to Turborepo

- [x] **Task 2: Verify package-level scripts** (AC: 2)
  - [x] Verify each package (`shared`, `mcp-server`, `ux`) has `build`, `dev`, `test` scripts
  - [x] Ensure scripts are consistent across packages

- [x] **Task 3: Verify build dependency order** (AC: 3)
  - [x] Confirm `turbo.json` has `"dependsOn": ["^build"]` for build task
  - [x] Verify `@harshjudge/shared` is listed as dependency in `mcp-server` and `ux` packages
  - [x] Test that running `pnpm build` builds `shared` before dependent packages

- [x] **Task 4: Verify TypeScript output configuration** (AC: 4, 5)
  - [x] Verify `outDir: "dist"` in each package's `tsconfig.json`
  - [x] Verify `sourceMap: true` in `tsconfig.base.json` for debugging support
  - [x] Confirm `declaration: true` and `declarationMap: true` for type definitions

- [x] **Task 5: Configure Vitest workspace** (AC: 6)
  - [x] Create `vitest.workspace.ts` at project root
  - [x] Configure workspace to include `packages/*/tests`
  - [x] Create `vitest.config.ts` in each package with appropriate settings
  - [x] Add `@vitest/coverage-v8` to root devDependencies for coverage support

- [x] **Task 6: Create test directory structure** (AC: 6)
  - [x] Create `packages/shared/tests/` directory with placeholder test
  - [x] Create `packages/mcp-server/tests/` directory with placeholder test
  - [x] Create `packages/ux/tests/` directory with placeholder test

- [x] **Task 7: Validate complete build workflow** (AC: 7)
  - [x] Run `pnpm install` to ensure dependencies are correct
  - [x] Run `pnpm build` and verify all packages compile without errors
  - [x] Run `pnpm test` and verify test framework executes
  - [x] Run `pnpm lint` and verify linting passes
  - [x] Run `pnpm typecheck` and verify type checking passes

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.1.story.md#Dev Agent Record]

From Story 1.1 implementation:
- Monorepo structure successfully initialized with pnpm 9.14.4 and Turborepo 2.3
- TypeScript 5.3+ configured with strict mode and additional safety flags
- ESLint 8.57 used (deprecation warning noted for future upgrade to ESLint 9)
- All packages use ESM (`"type": "module"`)
- Each package already has `build`, `dev`, `test`, `lint`, `typecheck`, `clean` scripts
- Workspace dependencies use `workspace:*` protocol

### Current State Analysis

**Root package.json scripts (already present):**
```json
{
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "clean": "turbo run clean && rm -rf node_modules",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\""
  }
}
```

**Missing:** `test:watch` script for watch mode.

**Turborepo configuration (already configured):**
- Build task has `"dependsOn": ["^build"]` - ensures `shared` builds first
- Test task has `"dependsOn": ["build"]` - ensures packages are built before testing
- Outputs configured to `dist/**` for caching

**Package scripts (already present in each package):**
- `build`: `tsc --build`
- `dev`: `tsc --build --watch`
- `test`: `vitest run`
- `lint`: `eslint src --ext .ts,.tsx`
- `typecheck`: `tsc --noEmit`
- `clean`: `rm -rf dist tsconfig.tsbuildinfo`

### Technology Stack Reference
[Source: architecture/3-tech-stack.md#31-technology-stack-table]

| Technology | Version | Purpose |
|------------|---------|---------|
| TypeScript | 5.3+ | Type safety across all packages |
| Vitest | 1+ | Unit and integration tests |
| Turborepo | 2.0+ | Build orchestration with caching |
| pnpm | 8+ | Package manager with workspace support |

### Vitest Workspace Configuration
[Source: architecture/15-testing-strategy.md#152-test-organization]

Vitest needs workspace configuration to support monorepo testing:

**`vitest.workspace.ts` (to create at root):**
```typescript
import { defineWorkspace } from 'vitest/config';

export default defineWorkspace([
  'packages/shared',
  'packages/mcp-server',
  'packages/ux',
]);
```

**Package-level `vitest.config.ts` template:**
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node', // or 'jsdom' for ux package
    include: ['tests/**/*.test.ts'],
  },
});
```

### Test Directory Structure
[Source: architecture/15-testing-strategy.md#152-test-organization]

```
packages/mcp-server/tests/
├── handlers/
├── services/
├── integration/
└── fixtures/

packages/ux/tests/
├── components/
├── hooks/
└── services/

packages/shared/tests/
└── (as needed)
```

### TypeScript Configuration Requirements
[Source: architecture/3-tech-stack.md, tsconfig.base.json from Story 1.1]

Required settings for source maps and declarations:
- `sourceMap: true` - generates `.js.map` files for debugging
- `declaration: true` - generates `.d.ts` type definition files
- `declarationMap: true` - generates `.d.ts.map` for "Go to Definition" in IDEs

### File Locations
[Source: architecture/11-unified-project-structure.md]

New files to create:
- `vitest.workspace.ts` - Root workspace configuration
- `packages/shared/vitest.config.ts` - Shared package test config
- `packages/mcp-server/vitest.config.ts` - MCP server test config
- `packages/ux/vitest.config.ts` - UX package test config
- `packages/shared/tests/index.test.ts` - Placeholder test
- `packages/mcp-server/tests/index.test.ts` - Placeholder test
- `packages/ux/tests/index.test.ts` - Placeholder test

Files to modify:
- `package.json` - Add `test:watch` script
- `tsconfig.base.json` - Verify source map settings

### Testing

[Source: architecture/15-testing-strategy.md]

**Test Framework:** Vitest 1+ (already in root devDependencies)

**Test Location:** Each package has its own `tests/` directory:
- `packages/mcp-server/tests/`
- `packages/ux/tests/`
- `packages/shared/tests/`

**Placeholder Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';

describe('Package Setup', () => {
  it('should pass placeholder test', () => {
    expect(true).toBe(true);
  });
});
```

**Validation Commands:**
```bash
pnpm install          # Verify dependencies
pnpm build            # Verify build succeeds
pnpm test             # Verify tests run
pnpm lint             # Verify linting passes
pnpm typecheck        # Verify type checking passes
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-04 | 1.1 | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Added `test:watch` script to root `package.json` for watch mode testing
- Added `@vitest/coverage-v8` to root devDependencies for coverage support
- Created `vitest.workspace.ts` at root to configure Vitest monorepo workspace
- Created `vitest.config.ts` in each package with appropriate test environments:
  - `shared` and `mcp-server`: `environment: 'node'`
  - `ux`: `environment: 'jsdom'` for React component testing
- Created placeholder tests in each package's `tests/` directory
- Added `jsdom` devDependency to `@harshjudge/ux` package for jsdom test environment
- All validations passed: `pnpm build`, `pnpm test` (3 tests passing), `pnpm lint`, `pnpm typecheck`
- Build order confirmed: `shared` builds before `mcp-server` and `ux`

### File List

**New Files:**
- `vitest.workspace.ts` - Root Vitest workspace configuration
- `packages/shared/vitest.config.ts` - Shared package Vitest config
- `packages/mcp-server/vitest.config.ts` - MCP server package Vitest config
- `packages/ux/vitest.config.ts` - UX package Vitest config
- `packages/shared/tests/index.test.ts` - Shared package placeholder test
- `packages/mcp-server/tests/index.test.ts` - MCP server package placeholder test
- `packages/ux/tests/index.test.ts` - UX package placeholder test

**Modified Files:**
- `package.json` - Added `test:watch` script and `@vitest/coverage-v8` devDependency
- `packages/ux/package.json` - Added `jsdom` devDependency
- `pnpm-lock.yaml` - Updated with new dependencies

---

## QA Results

### Review Date: 2025-12-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The implementation is clean, follows established patterns, and fully satisfies all acceptance criteria. This is a well-executed infrastructure story that properly sets up the build and development tooling for a monorepo.

**Strengths:**
- Vitest workspace configuration is correctly structured for monorepo support
- Package-level configurations appropriately differentiate environments (node vs jsdom)
- TypeScript configurations properly extend base and set up project references
- Turbo pipeline correctly defines build dependency order
- All validation commands pass without errors

### Refactoring Performed

None required - implementation is clean and follows best practices.

### Compliance Check

- Coding Standards: ✓ All files follow naming conventions (kebab-case for files, camelCase for exports)
- Project Structure: ✓ Files are in correct locations per architecture doc
- Testing Strategy: ✓ Vitest workspace configured as specified in testing-strategy.md
- All ACs Met: ✓ All 7 acceptance criteria verified (see traceability below)

### Requirements Traceability (Given-When-Then)

| AC | Requirement | Validation |
|----|-------------|------------|
| 1 | Root-level scripts | ✓ `build`, `dev`, `test`, `lint`, `clean`, `test:watch` present in root package.json |
| 2 | Package-level scripts | ✓ Each package has `build`, `dev`, `test` scripts |
| 3 | Build order (shared first) | ✓ `turbo.json` has `"dependsOn": ["^build"]`, verified shared builds first |
| 4 | TypeScript outputs to dist/ | ✓ `outDir: "./dist"` in each package's tsconfig.json |
| 5 | Source maps generated | ✓ `sourceMap: true` in tsconfig.base.json |
| 6 | Vitest workspace support | ✓ `vitest.workspace.ts` created, package-level configs present |
| 7 | Build completes for skeleton packages | ✓ Verified: `pnpm build` succeeds with all 3 packages |

### Improvements Checklist

All items addressed - no outstanding improvements required:

- [x] `test:watch` script added to root package.json
- [x] `@vitest/coverage-v8` added for coverage support
- [x] `vitest.workspace.ts` created with correct package references
- [x] Package-level `vitest.config.ts` files with appropriate environments
- [x] Placeholder tests in all three packages
- [x] `jsdom` added to `@harshjudge/ux` for DOM testing environment
- [x] TypeScript project references configured correctly

### Security Review

**N/A** - This story covers build tooling configuration only. No security-sensitive code was introduced.

### Performance Considerations

**Positive findings:**
- Turborepo caching is working correctly (`FULL TURBO` output indicates cache hits)
- Build dependency ordering prevents unnecessary rebuilds
- Test execution is fast (~1-3s per package)

### Files Modified During Review

None - no modifications were necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.2-configure-build-development-tooling.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, all validations pass, implementation follows best practices.

---

### Review Date: 2025-12-04 (Re-verification)

### Reviewed By: Quinn (Test Architect)

### Verification Summary

**Purpose**: Re-verification of previous PASS gate status.

**Validation Results (Re-run)**:
| Command | Result |
|---------|--------|
| `pnpm build` | ✓ PASS - 3 packages built (FULL TURBO cache hit) |
| `pnpm test` | ✓ PASS - 3 tests passing (1 per package) |
| `pnpm lint` | ✓ PASS - No linting errors |
| `pnpm typecheck` | ✓ PASS - No type errors |

### Files Verified

All implementation files from previous review confirmed present and unchanged:
- ✓ `vitest.workspace.ts` - Root workspace configuration
- ✓ `packages/shared/vitest.config.ts` - Node environment
- ✓ `packages/mcp-server/vitest.config.ts` - Node environment
- ✓ `packages/ux/vitest.config.ts` - jsdom environment
- ✓ `packages/*/tests/index.test.ts` - Placeholder tests (3 files)
- ✓ `package.json` - Contains `test:watch` script and `@vitest/coverage-v8`
- ✓ `tsconfig.base.json` - Contains `sourceMap: true`, `declaration: true`, `declarationMap: true`
- ✓ `turbo.json` - Contains `"dependsOn": ["^build"]` for correct build order

### Gate Status

Gate: **PASS** (Verified) → docs/qa/gates/1.2-configure-build-development-tooling.yml

### Recommended Status

✓ **Ready for Done** - Previous PASS gate verified. All acceptance criteria remain satisfied.
