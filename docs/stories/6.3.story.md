# Story 6.3: Per-Step Run Structure

## Status

Done

## Story

**As a** HarshJudge user,
**I want** run evidence organized by step,
**so that** I can easily debug specific step failures.

## Acceptance Criteria

1. New run structure:
   ```
   .harshJudge/scenarios/{slug}/runs/{runId}/
   ├── result.json
   ├── step-01/
   │   └── evidence/
   │       ├── before.png
   │       ├── after.png
   │       └── console.json
   ├── step-02/
   │   └── evidence/
   └── ...
   ```
2. `result.json` schema includes per-step status:
   ```json
   {
     "runId": "run_abc123",
     "scenarioSlug": "login-flow",
     "status": "fail",
     "startedAt": "2024-01-15T10:30:00Z",
     "completedAt": "2024-01-15T10:31:15Z",
     "duration": 75000,
     "steps": [
       { "id": "01", "status": "pass", "duration": 5000 },
       { "id": "02", "status": "pass", "duration": 8000 },
       { "id": "03", "status": "fail", "duration": 12000, "error": "Element not found" }
     ],
     "failedStep": "03",
     "errorMessage": "Element not found: Submit button"
   }
   ```
3. Evidence files use consistent naming: `before.png`, `after.png`, `console.json`, `network.json`
4. `recordEvidence` MCP tool updated to accept `stepId` parameter
5. `completeRun` MCP tool updated to accept per-step results

## Tasks / Subtasks

- [ ] Task 1: Define StepResult and update RunResult types (AC: 2)
  - [ ] Open `packages/shared/src/types/run.ts`
  - [ ] Add `StepResult` interface: id, status, duration, error, evidenceFiles
  - [ ] Update `RunResult` to include `steps: StepResult[]` array
  - [ ] Change `failedStep` type from `number` to `string` (step ID)
  - [ ] Export new types from `packages/shared/src/index.ts`

- [ ] Task 2: Update Evidence types with stepId (AC: 4)
  - [ ] Open `packages/shared/src/types/evidence.ts`
  - [ ] Add `stepId: string` to `Evidence` interface
  - [ ] Add `stepId: string` to `EvidenceMeta` interface
  - [ ] Update zod schemas for validation

- [ ] Task 3: Update recordEvidence handler (AC: 4)
  - [ ] Open `packages/mcp-server/src/handlers/record-evidence.ts`
  - [ ] Change `step: number` parameter to `stepId: string`
  - [ ] Update evidence path: `runs/{runId}/step-{stepId}/evidence/{name}.{ext}`
  - [ ] Create step directory if it doesn't exist
  - [ ] Update return type to include `stepPath`

- [ ] Task 4: Update RecordEvidenceParams schema (AC: 4)
  - [ ] Open `packages/shared/src/types/mcp-tools.ts`
  - [ ] Change `step: z.number()` to `stepId: z.string().regex(/^\d{2}$/)`
  - [ ] Add validation message for zero-padded format
  - [ ] Update `RecordEvidenceResult` to include `stepPath`

- [ ] Task 5: Update completeRun handler (AC: 5)
  - [ ] Open `packages/mcp-server/src/handlers/complete-run.ts`
  - [ ] Accept `steps: StepResult[]` in params (optional, for backward compat)
  - [ ] Change `failedStep` type from `number` to `string`
  - [ ] Write per-step results to result.json
  - [ ] Calculate aggregate status from step results

- [ ] Task 6: Update CompleteRunParams schema (AC: 5)
  - [ ] Update `failedStep` to `z.string().regex(/^\d{2}$/).optional()`
  - [ ] Add optional `steps` array parameter for per-step results

- [ ] Task 7: Update FileSystemService for per-step evidence (AC: 1, 3)
  - [ ] Add `ensureStepEvidenceDir(runPath: string, stepId: string)` method
  - [ ] Add `getStepEvidencePath(runPath: string, stepId: string, name: string)` method
  - [ ] Update gitignore patterns for new structure

- [ ] Task 8: Add completeStep handler (NEW) (AC: 2)
  - [ ] Create `packages/mcp-server/src/handlers/complete-step.ts`
  - [ ] Implement `handleCompleteStep` function
  - [ ] Update in-progress result.json with step status
  - [ ] Return `nextStepId` or `null` if last step
  - [ ] Register in server.ts tool list

- [ ] Task 9: Write unit tests (AC: 1-5)
  - [ ] Test StepResult type validation
  - [ ] Test evidence path generation with stepId
  - [ ] Test result.json includes per-step results
  - [ ] Test completeStep returns correct nextStepId

## Dev Notes

### Architecture References

**StepResult Type** [Source: architecture/4-data-models.md#4.7]
```typescript
// packages/shared/src/types/run.ts
export interface StepResult {
  id: string;
  status: 'pass' | 'fail' | 'skipped';
  duration: number;
  error: string | null;
  evidenceFiles: string[];
}
```

**Updated RunResult** [Source: architecture/4-data-models.md#4.8]
```typescript
export interface RunResult {
  runId: string;
  scenarioSlug: string;
  status: 'pass' | 'fail';
  startedAt: string;
  completedAt: string;
  duration: number;
  steps: StepResult[];        // NEW
  failedStep: string | null;  // Changed from number to step ID
  errorMessage: string | null;
}
```

**Updated RecordEvidenceParams** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export const RecordEvidenceParams = z.object({
  runId: z.string().min(1),
  stepId: z.string().regex(/^\d{2}$/, 'Step ID must be zero-padded (e.g., "01", "02")'),
  type: z.enum(['screenshot', 'db_snapshot', 'console_log', 'network_log', 'html_snapshot', 'custom']),
  name: z.string().min(1).max(100),
  data: z.string(),
  metadata: z.record(z.unknown()).optional(),
});
```

**New completeStep Tool** [Source: architecture/5-api-specification-mcp-tools.md#5.1]
```typescript
export const CompleteStepParams = z.object({
  runId: z.string().min(1),
  stepId: z.string().regex(/^\d{2}$/),
  status: z.enum(['pass', 'fail', 'skipped']),
  duration: z.number().nonnegative(),
  error: z.string().optional(),
});

export interface CompleteStepResult {
  success: boolean;
  runId: string;
  stepId: string;
  status: 'pass' | 'fail' | 'skipped';
  nextStepId: string | null;  // null if last step or should stop
}
```

**Evidence Naming** [Source: architecture/8-database-schema.md#8.3]
| Name | Type | Description |
|------|------|-------------|
| `before.png` | screenshot | State before action |
| `after.png` | screenshot | State after action |
| `error.png` | screenshot | State when error occurred |
| `console.json` | console_log | Browser console messages |
| `network.json` | network_log | Network requests/responses |

### File Locations

| Purpose | Path |
|---------|------|
| Run types | `packages/shared/src/types/run.ts` |
| Evidence types | `packages/shared/src/types/evidence.ts` |
| MCP tool schemas | `packages/shared/src/types/mcp-tools.ts` |
| recordEvidence handler | `packages/mcp-server/src/handlers/record-evidence.ts` |
| completeRun handler | `packages/mcp-server/src/handlers/complete-run.ts` |
| completeStep handler (NEW) | `packages/mcp-server/src/handlers/complete-step.ts` |
| FileSystemService | `packages/mcp-server/src/services/file-system-service.ts` |
| Server registration | `packages/mcp-server/src/server.ts` |

### Key Implementation Notes

1. **Backward Compatibility**: The `completeRun` handler should work with or without `steps` array. If no steps provided, create a single-step result from the overall status.

2. **Path Structure**: Evidence paths change from flat to nested:
   ```
   # Old (v1)
   runs/{runId}/evidence/step-1-before.png

   # New (v2)
   runs/{runId}/step-01/evidence/before.png
   ```

3. **completeStep Logic**: When `completeStep` is called:
   - Read current result.json (or create if first step)
   - Add/update the step in the `steps` array
   - If status is 'fail', set `failedStep` and return `nextStepId: null`
   - If status is 'pass'/'skipped', return next step ID from meta.yaml

4. **Error Handling**: Follow existing MCP error handler pattern. Invalid stepId format throws validation error.

5. **Gitignore Update**: Update `.harshJudge/.gitignore` pattern:
   ```
   scenarios/*/runs/*/step-*/evidence/*.png
   scenarios/*/runs/*/step-*/evidence/*.html
   ```

### Testing

**Test File Locations**:
- `packages/shared/tests/types/run.test.ts`
- `packages/mcp-server/tests/handlers/record-evidence.test.ts`
- `packages/mcp-server/tests/handlers/complete-step.test.ts`
- `packages/mcp-server/tests/handlers/complete-run.test.ts`

**Testing Framework**: Vitest with memfs [Source: architecture/15-testing-strategy.md]

**Test Patterns**:
```typescript
describe('recordEvidence with stepId', () => {
  it('creates evidence in step directory', async () => {
    await handleRecordEvidence({
      runId: 'run_123',
      stepId: '01',
      type: 'screenshot',
      name: 'before',
      data: '/path/to/screenshot.png'
    });

    expect(vol.existsSync('.harshJudge/scenarios/test/runs/run_123/step-01/evidence/before.png'))
      .toBe(true);
  });
});

describe('completeStep', () => {
  it('returns nextStepId for passing step', async () => {
    const result = await handleCompleteStep({
      runId: 'run_123',
      stepId: '01',
      status: 'pass',
      duration: 5000
    });

    expect(result.nextStepId).toBe('02');
  });

  it('returns null nextStepId on failure', async () => {
    const result = await handleCompleteStep({
      runId: 'run_123',
      stepId: '02',
      status: 'fail',
      duration: 3000,
      error: 'Element not found'
    });

    expect(result.nextStepId).toBeNull();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-18 | 1.0 | Initial story draft | SM Agent (Bob) |
